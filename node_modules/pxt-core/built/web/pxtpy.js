var pxt;!function(e){!function(e){let t;!function(e){e[e.NonLocal=0]="NonLocal",e[e.Global=1]="Global"}(t=e.VarModifier||(e.VarModifier={})),e.isIndex=function(e){return"Index"===e.kind},e.isSubscript=function(e){return"Subscript"===e.kind}}(e.py||(e.py={}))}(pxt||(pxt={})),function(e){!function(t){var n=e.blocks;let r,i,s,o,a,l,u,c,p,f,m=0,d=0,y=0,k="???";function x(e){return null==e}function T(e){return null!=e}function g(t){return e.tickEvent("python.todo.statement",{kind:t.kind}),n.mkStmt(n.mkText("TODO: "+t.kind))}function h(t){return e.tickEvent("python.todo.expression",{kind:t.kind}),n.mkText(" {TODO: "+t.kind+"} ")}const v=$({primType:"string"}),S=$({primType:"number"}),b=$({primType:"boolean"}),N=$({primType:"void"}),E=$({primType:"any"});let C;const U={str:v,string:v,number:S,bool:b,void:N,any:E};function P(e){switch(e){case ts.SyntaxKind.StringKeyword:return v;case ts.SyntaxKind.NumberKeyword:return S;case ts.SyntaxKind.BooleanKeyword:return b;case ts.SyntaxKind.VoidKeyword:return N;case ts.SyntaxKind.AnyKeyword:return E;default:return C}}function I(t){let n=e.U.flatClone(t);return delete n.pyAST,delete n.pyInstanceType,delete n.pyRetType,delete n.pySymbolType,delete n.moduleTypeMarker,delete n.declared,n.parameters&&(n.parameters=n.parameters.map(t=>(delete(t=e.U.flatClone(t)).pyType,t))),n}function w(t){if("("==t[0]&&e.U.endsWith(t,")"))return w(t.slice(1,-1));const n=t.indexOf(" => ");if(n>0){const e=t.slice(n+4);if(-1==e.indexOf(")[]")){const r=w(e),i=t.slice(1,n-1);return F(r,(i?i.split(/, /):[]).map(e=>w(e.replace(/\w+\??: /,""))))}}if(e.U.endsWith(t,"[]"))return L(w(t.slice(0,-2)));if("_py.Array"===t)return L(E);const r=e.U.lookup(U,t);if(r)return r;if(!!t&&!isNaN(t))return S;if("T"==t||"U"==t)return $({primType:"'"+t});if(t.indexOf("|")>=0){return $({primType:"@union",typeArgs:t.split("|").map(e=>e.trim()).map(w)})}let i=_(t+"@type")||_(t);return i?7==i.kind?S:8==i.kind||9==i.kind?i.pyInstanceType||$({classType:i}):6==i.kind?S:(H(null,9502,e.U.lf("'{0}' is not a type near '{1}'",t,k||"???")),$({primType:t})):(H(null,9501,e.U.lf("unknown type '{0}' near '{1}'",t,k||"???")),$({primType:t}))}function A(t){var n;if(!t.pySymbolType){if(k=t.pyQName,t.parameters){pxtc.service.isTaggedTemplate(t)&&(t.parameters=[{name:"literal",description:"",type:"string",options:{}}]);for(let e of t.parameters)e.pyType||(e.pyType=w(e.type))}const r=t.pyRetType;if(xe(t))t.pyRetType=$({moduleType:t});else if(t.retType)if((null===(n=t.qName)||void 0===n?void 0:n.endsWith(".__constructor"))&&"void"===t.retType){const e=K(t.qName.substring(0,t.qName.lastIndexOf(".")));t.pyRetType=e?$({classType:e}):w(t.retType)}else t.pyRetType=w(t.retType);else t.pyRetType||(e.U.oops("no type for: "+t.pyQName),t.pyRetType=$({}));if(r&&ee(t.pyAST,r,t.pyRetType),3==t.kind||1==t.kind){let n=t.parameters.map(e=>e.pyType);if(n.some(x))return H(null,9526,e.U.lf("function symbol is missing parameter types near '{1}'",k||"???")),$({});t.pySymbolType=F(t.pyRetType,n.filter(T))}else t.pySymbolType=t.pyRetType;8!=t.kind&&9!=t.kind||(t.pyInstanceType=$({classType:t})),k=void 0}return t.pySymbolType}function _(t){return e.U.lookup(i,t)||e.U.lookup(r,t)}function K(e){var t;if(!e)return;let n=_(e);if(n)A(n);else if(e.indexOf(".")&&!e.endsWith(".__constructor")){const n=e.substring(0,e.lastIndexOf(".")),r=K(n);if(8===(null==r?void 0:r.kind)&&(null===(t=r.extendsTypes)||void 0===t?void 0:t.length))return K(r.extendsTypes[0]+e.substring(n.length))}return n}function $(t={}){let n=e.U.flatClone(t);return n.tid=++d,n}function L(e){return $({primType:"@array",typeArgs:[e]})}function F(e,t){return $({primType:"@fn"+t.length,typeArgs:[e].concat(t)})}function D(t){return!!e.U.startsWith(t.primType||"","@fn")}function O(t){return!!t.primType&&!e.U.startsWith(t.primType,"@")}function R(t){return!!e.U.startsWith(t.primType||"","@union")}function q(){return s.currFun||s.currClass||s.currModule}function M(){let e=q();for(;e&&e.parent;)e=e.parent;return e}function G(){return"main"==s.currModule.name&&!s.currFun&&!s.currClass}function B(t,n,r){const i=K(n);return i||H(t,9503,e.U.lf("No module named '{0}'",n)),i}function Q(e,n,r,i){i||(i=q());let s=i.vars[e],o=null==s?void 0:s.symbol;if(!o){let n=W(i);n&&(n+=".");let a=n+e;o="ClassDef"===i.kind?oe(2,a):!ae(i)||r!==t.VarModifier.Global&&r!==t.VarModifier.NonLocal?ae(i)?se(4,e):oe(4,a):oe(4,e),s={symbol:o,modifier:r},i.vars[e]=s}for(let e of Object.keys(n))o[e]=n[e];return s}function z(e){return e.unifyWith?(e.unifyWith=z(e.unifyWith),e.unifyWith):e}function W(e){let t=e,n="";t.parent&&"FunctionDef"!==t.parent.kind&&"AsyncFunctionDef"!==t.parent.kind&&(n=W(t.parent),n?n+=".":n="");let r=e;return"Module"==e.kind&&"main"==r.name?"":r.name?n+r.name:n+"?"+e.kind}function j(t){let n=e.U.lookup(Ue,t);if(n)return n;for(let n of e.U.values(s.currModule.vars)){let r=n.symbol;if(r.isImport){if(r.expandsTo==t)return r.pyName||H(null,9553,lf("missing pyName")),r.pyName;if(r.isImport&&e.U.startsWith(t,(r.expandsTo||"")+"."))return r.pyName+t.slice(r.expandsTo.length)}}return t}function V(e){return(e=z(e)).primType?e.typeArgs&&"@array"==e.primType?V(e.typeArgs[0])+"[]":D(e)&&e.typeArgs?"("+e.typeArgs.slice(1).map(e=>"_: "+V(e)).join(", ")+") => "+V(e.typeArgs[0]):R(e)&&e.typeArgs?e.typeArgs.map(V).join(" | "):e.primType+"":e.classType&&e.classType.pyQName?j(e.classType.pyQName)+"":e.moduleType&&e.moduleType.pyQName?j(e.moduleType.pyQName)+"":"any"}function H(e,t,n){l.push(function(e,t,n,r){return e||(e=o),e&&s&&s.currModule?{fileName:a,start:e.startPos,length:e.endPos-e.startPos,line:void 0,column:void 0,code:n,category:t,messageText:r}:{fileName:a,start:0,length:0,line:void 0,column:void 0,code:n,category:t,messageText:r}}(e,pxtc.DiagnosticCategory.Error,t,n))}function J(e){return e.primType?e.primType:e.classType?e.classType:e.moduleType?(e.moduleType.moduleTypeMarker||(e.moduleType.moduleTypeMarker={}),e.moduleType.moduleTypeMarker):null}function X(e){return!J(z(e))}function Y(t,n,r){var i;(n=z(n)).classType!=r&&(X(n)?n.classType=r:ee(t,n,(A(i=r),i.pyInstanceType||H(null,9527,e.U.lf("Instance type symbol '{0}' is missing pyInstanceType",i)),i.pyInstanceType)))}function Z(e,t){ee(e,ke(e),t)}function ee(t,n,r){if(n===r)return;if((n=z(n))===(r=z(r))||ie(n)||ie(r))return;if("any"===n.primType)return void(n.unifyWith=r);const i=J(n),s=J(r);if(i&&s)if(i===s){if(n.unifyWith=r,n.typeArgs&&r.typeArgs)for(let e=0;e<Math.min(n.typeArgs.length,r.typeArgs.length);++e)ee(t,n.typeArgs[e],r.typeArgs[e]);n.unifyWith=r}else!function(t,n,r){H(t,9500,e.U.lf("types not compatible: {0} and {1}",V(n),V(r)))}(t,n,r);else i&&!s?ee(t,r,n):(y++,n.unifyWith=r)}function te(e,t){const n=z(e),r=z(t);if(n===r)return!0;const i=J(n),s=J(r);if(i===s)return!0;if(i&&s){if(re(i)&&re(s)&&i.extendsTypes&&i.extendsTypes.length&&i.extendsTypes.some(e=>e===s.qName))return!0;if(R(r)){for(let e of r.typeArgs||[])if(te(n,e))return!0;return!1}}return!1}function ne(e,t){const n=z(ke(e)),r=z(t);te(n,r)||(D(n)||D(r)||O(n)||O(r))&&ee(e,n,r)}function re(e){return!!(null==e?void 0:e.name)}function ie(e){var t;return!!(null===(t=null==e?void 0:e.primType)||void 0===t?void 0:t.startsWith("'"))}function se(e,t){let n=/(.*)\.(.*)/.exec(t),r=n?n[2]:t;return{kind:e,name:r,pyName:r,qName:t,pyQName:t,namespace:n?n[1]:"",attributes:{},pyRetType:$()}}function oe(t,n){let r=i[n];return r?(r.kind=t,r):(r=se(t,n),r.pyQName||H(null,9527,e.U.lf("Symbol '{0}' is missing pyQName",n)),i[r.pyQName]=r,r)}function ae(e){let t=e;for(;t;){if("FunctionDef"==t.kind)return!0;t=t.parent}return!1}function le(t,n,r){if(!n.symInfo){let i=W(n);e.U.endsWith(i,".__init__")&&(i=i.slice(0,-9)+".__constructor"),ae(r=r||q())?n.symInfo=se(t,i):n.symInfo=oe(t,i);const s=n.symInfo;s.pyAST=n,s.pyName||H(null,9528,e.U.lf("Symbol '{0}' is missing pyName",s.qName||s.name)),r.vars[s.pyName]={symbol:s}}return n.symInfo}function ue(t){let n=t.symInfo.qName;return e.U.values(i).filter(e=>e.namespace==n&&2==e.kind)}function ce(t,n,r,i=!1,s=!1){let o;o="__init__"===n?t.pyQName+".__constructor":n.startsWith(t.pyQName+".")?n:t.pyQName+"."+n;let a=K(o);if(a)return a;if(!s)for(let i of t.extendsTypes||[]){let s=K(i);if(s){s==t&&e.U.userError("field lookup loop on: "+s.qName+" / "+n);let i=ce(s,n,r,!0);if(i)return i}}if(!i&&t.pyAST&&"ClassDef"==t.pyAST.kind){let e=oe(2,o);return e.isInstance=!r,e}return null}function pe(t,n,r=!1){const i=ke(t),o=function(e){let t=z(e);return[t.classType,...fe(t.primType),t.moduleType].filter(T)}(i);for(let a of o){let o=!!i.moduleType,l=ce(a,n,o,r);if(l)return o?l.isInstance&&H(null,9505,e.U.lf("the field '{0}' of '{1}' is not static",n,a.pyQName)):ze(t)?l.isProtected=!0:We(t)&&(s.currClass||H(null,9529,e.U.lf("no class context found for {0}",l.pyQName)),l.namespace!=s.currClass.symInfo.qName&&(l.isProtected=!0)),l}return null}function fe(e){let t=[];return"@array"==e?t=[_("_py.Array"),_("Array")]:"string"==e&&(t=[_("_py.String"),_("String")]),t.filter(e=>!!e)}function me(t){let n=q(),r=e.U.lookup(n.vars,t);if(r)return r;for(;n;){let r=e.U.lookup(n.vars,t);if(r)return r;do{n=n.parent}while(n&&"ClassDef"==n.kind)}return null}function de(e){if(!e)return null;const t=e.indexOf(".");if(t>0){const n=me(e.slice(0,t)),r=null==n?void 0:n.symbol;r&&r.pyQName!=r.pyName&&(e=r.pyQName+e.slice(t))}else{const t=me(e);if(t)return t}let n=K(e);return n?{symbol:n}:void 0}function ye(e){var t;return null===(t=de(e))||void 0===t?void 0:t.symbol}function ke(e){return e.tsType?z(e.tsType):(e.tsType=$(),e.tsType)}function xe(e){if(!e)return!1;switch(e.kind){case 5:case 9:case 8:case 6:return!0;default:return!1}}function Te(t){const n=e.U.flatClone(s);let r;try{r=t()}finally{s=n}return r}function ge(e,t){return 0==t.length?n.mkText(""):n.mkGroup([n.mkText("/* TODO: "+e+" "),n.mkGroup(t),n.mkText(" */"),n.mkNewLine()])}function he(e){let t=nt(e.value);return e.arg?n.mkInfix(n.mkText(e.arg),"=",t):n.mkGroup([n.mkText("**"),t])}function ve(n){if(!n)return $();let r=Oe(n);if(r){let t=_(r+"@type")||_(r);if(t){if(A(t),6==t.kind)return S;if(t.pyInstanceType)return t.pyInstanceType}else if(U[r])return U[r];H(n,9506,e.U.lf("cannot find type '{0}'",r))}else if(t.isSubscript(n)){if("List"===Oe(n.value)&&t.isIndex(n.slice)){return L(ve(n.slice.value))}}return H(n,9507,e.U.lf("invalid type syntax")),$({})}function Se(e){return e.pyName&&"_"==e.pyName[0]?e.isProtected?n.mkText("protected "):n.mkText("private "):n.mkText("")}const be={Sub:1,Div:1,Pow:1,LShift:1,RShift:1,BitOr:1,BitXor:1,BitAnd:1,FloorDiv:1,Mult:1},Ne={Eq:1,NotEq:1,Lt:1,LtE:1,Gt:1,GtE:1},Ee={Add:"+",Sub:"-",Mult:"*",MatMult:"Math.matrixMult",Div:"/",Mod:"%",Pow:"**",LShift:"<<",RShift:">>",BitOr:"|",BitXor:"^",BitAnd:"&",FloorDiv:"Math.idiv",And:"&&",Or:"||",Eq:"==",NotEq:"!=",Lt:"<",LtE:"<=",Gt:">",GtE:">=",Is:"===",IsNot:"!==",In:"py.In",NotIn:"py.NotIn"},Ce={Invert:"~",Not:"!",UAdd:"P+",USub:"P-"},Ue={"adafruit_bus_device.i2c_device.I2CDevice":"pins.I2CDevice"};function Pe(e){s.blockDepth++;const t=n.mkBlock(e.map(rt));return s.blockDepth--,t}function Ie(e){e.vars||(e.vars={},e.parent=q(),e.blockDepth=s.blockDepth)}function we(e,t=!1){return"any"===V(e)?t?n.mkText(": any"):n.mkText(""):n.mkText(": "+V(e))}function Ae(t,r){try{return Te(r)}catch(r){return e.log(r),n.mkStmt(ge(`conversion failed for ${t.name||t.kind}`,[]))}}function _e(e){if(!e||!e.pyAST)return!1;if("FunctionDef"!=e.pyAST.kind)return!1;const t=e.pyAST;return!(!t.callers||1!=t.callers.length)&&!t.callers[0].inCalledPosition}function Ke(t,r=!1){return Ae(t,()=>{var i,o,a,l;const u=!!s.currClass&&!s.currFun,c=G(),p=!!s.currFun;Ie(t);const f=ye(W(t)),d=le(u?1:3,t);if(!r&&(f&&f.declared===m&&H(t,9520,lf("Duplicate function declaration")),d.declared=m,_e(d)))return n.mkText("");u&&(d.isInstance=!0),s.currFun=t;let y="",k=t.name;let x=[ge("decorators",t.decorator_list.filter(e=>"property"==Oe(e)?(y="get",!1):"Attribute"!=e.kind||"setter"!=e.attr||"Name"!=e.value.kind||(k=e.value.id,y="set",!1)).map(nt))];if(t.body.length>=1&&"Raise"==t.body[0].kind&&(t.alwaysThrows=!0),u)if(s.currClass||H(t,9531,lf("method '{0}' is missing current class context",d.pyQName)),d.pyRetType||H(t,9532,lf("method '{0}' is missing a return type",d.pyQName)),"__init__"==t.name)x.push(n.mkText("constructor")),Y(t,d.pyRetType,s.currClass.symInfo);else{if("__get__"==k||"__set__"==k){let e=t.vars.value,n=null==e?void 0:e.symbol;if("__set__"==k&&n){let e=ce(s.currClass.symInfo,"__get__",!1);e&&e.pyAST&&"FunctionDef"==e.pyAST.kind&&ee(t,n.pyRetType,e.pyRetType)}k=k.replace(/_/g,"")}y||(y="_"==k[0]?d.isProtected?"protected":"private":"public",t.symInfo.isStatic&&(y+=" static")),x.push(n.mkText(y+" "),qe(k))}else e.U.assert(!y),"_"==t.name[0]||c||r||p?x.push(n.mkText("function "),qe(k)):x.push(n.mkText("export function "),qe(k));let T="__init__"==t.name?void 0:t.returns?ve(t.returns):d.pyRetType;x.push(function(t,r){var i;const s=t.args;s.kwonlyargs.length&&H(t,9517,e.U.lf("keyword-only arguments not supported yet"));let o=s.args.slice();if(r?"self"!==(null===(i=o[0])||void 0===i?void 0:i.arg)?t.symInfo.isStatic=!0:o.shift():o.some(e=>"self"==e.arg)&&H(t,9519,e.U.lf("non-methods cannot have an argument called 'self'")),!t.symInfo.parameters){let r=s.defaults.length-o.length;t.symInfo.parameters=o.map(i=>{i.annotation||H(t,9519,e.U.lf("Arg '{0}' missing annotation",i.arg));let o=ve(i.annotation),a="";return r>=0&&(a=n.flattenNode([nt(s.defaults[r])]).output,ee(i,o,ke(s.defaults[r]))),r++,{name:i.arg,description:"",type:"",initializer:a,default:a,pyType:o}})}let a=t.symInfo.parameters.map(r=>{let i=Q(r.name,{isParam:!0}),s=null==i?void 0:i.symbol;r.pyType||H(t,9530,e.U.lf("parameter '{0}' missing pyType",r.name)),ee(t,A(s),r.pyType);let o=[qe(r.name),we(r.pyType,!0)];return r.default&&o.push(n.mkText(" = "+r.default)),n.mkGroup(o)});return s.vararg&&a.push(n.mkText("TODO *"+s.vararg.arg)),s.kwarg&&a.push(n.mkText("TODO **"+s.kwarg.arg)),n.H.mkParenthesizedExpression(n.mkCommaSep(a))}(t,u),T&&z(T)!=N?we(T):n.mkText("")),A(d);let g=t.body.map(rt);if("__init__"==t.name){if(s.currClass||H(t,9533,lf("__init__ method '{0}' is missing current class context",d.pyQName)),null===(i=s.currClass)||void 0===i?void 0:i.baseClass){const e=t.body[0],n=s.currClass.baseClass.pyQName+".__constructor";(null===(l=null===(a=null===(o=e.value)||void 0===o?void 0:o.func)||void 0===a?void 0:a.symbolInfo)||void 0===l?void 0:l.pyQName)!==n&&H(t,9575,lf("Sub classes must call 'super().__init__' as the first statement inside an __init__ method"))}for(let e of ue(s.currClass)){let t=e.pyAST;t&&t.value&&g.push(n.mkStmt(n.mkText(`this.${De(e.pyName)} = `),nt(t.value)))}}const h=at(t);x.push(n.mkBlock(h.concat(g)));let v=n.mkGroup(x);return r?x[x.length-1].noFinalNewline=!0:v=n.mkStmt(v),v})}const $e={FunctionDef:e=>Ke(e),ClassDef:t=>Ae(t,()=>{Ie(t);const r=le(8,t);e.U.assert(!s.currClass);let i=G();s.currClass=t,t.isNamespace=t.decorator_list.some(e=>"Name"==e.kind&&"namespace"==e.id);let o=t.isNamespace?[n.mkText("namespace "),qe(t.name)]:[ge("keywords",t.keywords.map(he)),ge("decorators",t.decorator_list.map(nt)),n.mkText(i?"class ":"export class "),qe(t.name)];if(!t.isNamespace&&t.bases.length>0)if("Enum"==Oe(t.bases[0]))t.isEnum=!0;else{o.push(n.mkText(" extends ")),o.push(n.mkCommaSep(t.bases.map(nt)));let e=function(e){let t=ye(Re(e));return t&&t.pyAST&&"ClassDef"==t.pyAST.kind?t.pyAST:null}(t.bases[0]);if(e)t.baseClass=e.symInfo,r.extendsTypes=[e.symInfo.pyQName];else{const e=Oe(t.bases[0]);if(e){const n=ye(e),i=K(e);t.baseClass=n||i,t.baseClass&&(r.extendsTypes=[t.baseClass.pyQName])}}}const a=t.body.filter(e=>t.isNamespace||"FunctionDef"===e.kind),l=t.isNamespace?[]:t.body.filter(e=>-1===a.indexOf(e)&&"Pass"!==e.kind);let u=Pe(a);o.push(u);let c=!1;if(l.length){c=!0;const e=Pe(l),r=n.mkStmt(n.mkGroup([n.mkText(`public static __init${t.name}() `),e]));u.children.unshift(r)}if(!t.isNamespace){const e=ue(t).map(e=>(e.pyName&&e.pyRetType||H(t,9535,lf("field definition missing py name or return type",e.qName)),e)),r=e.filter(e=>!e.isInstance),i=e.filter(e=>e.isInstance).map(e=>n.mkStmt(Se(e),qe(e.pyName),we(e.pyRetType))),s=r.map(e=>n.mkGroup([n.mkStmt(Se(e),n.mkText("static "),qe(e.pyName),we(e.pyRetType)),dt(De(t.name),De(e.pyName),V(e.pyRetType))]));u.children=s.concat(i).concat(u.children)}return c&&(o=[n.mkStmt(n.mkGroup(o)),n.mkStmt(n.mkText(`${t.name}.__init${t.name}()`))]),n.mkStmt(n.mkGroup(o))}),Return:e=>{if(e.value){let t=s.currFun;return t&&(t.symInfo.pyRetType||H(e,9536,lf("function '{0}' missing return type",t.symInfo.pyQName)),Z(e.value,t.symInfo.pyRetType)),n.mkStmt(n.mkText("return "),nt(e.value))}return n.mkStmt(n.mkText("return"))},AugAssign:e=>{let t=Ee[e.op];return t.length>3?n.mkStmt(n.mkInfix(nt(e.target),"=",n.H.mkCall(t,[nt(e.target),nt(e.value)]))):n.mkStmt(nt(e.target),n.mkText(" "+t+"= "),nt(e.value))},Assign:e=>Le(e),AnnAssign:e=>Le(e),For:t=>{if(e.U.assert(0==t.orelse.length),t.target.forTargetEndPos=t.endPos,Me(t.iter,"range")){let e=t.iter,r=nt(t.target),i=qe(Re(t.target));Z(t.target,S);let s=1==e.args.length?n.mkText("0"):nt(e.args[0]),o=nt(e.args[1==e.args.length?0:1]);if(e.args.length<=2)return n.mkStmt(n.mkText("for ("),n.mkInfix(r,"=",s),n.mkText("; "),n.mkInfix(i,"<",o),n.mkText("; "),n.mkPostfix([i],"++"),n.mkText(")"),Pe(t.body));let a="Num"===e.args[2].kind?e.args[2].n:void 0;if(null==a&&"UnaryOp"===e.args[2].kind){const t=e.args[2];"Num"===t.operand.kind&&("UAdd"===t.op?a=t.operand.n:"USub"===t.op&&(a=-t.operand.n))}if(void 0!==a){const l=a>0?"<":">";return n.mkStmt(n.mkText("for ("),n.mkInfix(r,"=",s),n.mkText("; "),n.mkInfix(i,l,o),n.mkText("; "),n.mkInfix(i,"+=",nt(e.args[2])),n.mkText(")"),Pe(t.body))}}if(m>1){const e=ke(t.target);Z(t.iter,ke(t.iter)==v?e:L(e))}return n.mkStmt(n.mkText("for ("),nt(t.target),n.mkText(" of "),nt(t.iter),n.mkText(")"),Pe(t.body))},While:t=>(e.U.assert(0==t.orelse.length),n.mkStmt(n.mkText("while ("),nt(t.test),n.mkText(")"),Pe(t.body))),If:t=>{let r=t=>{let i=[n.mkText("if ("),nt(t.test),n.mkText(")"),Pe(t.body)];return t.orelse.length&&(i[i.length-1].noFinalNewline=!0,1==t.orelse.length&&"If"==t.orelse[0].kind?(i.push(n.mkText(" else ")),e.U.pushRange(i,r(t.orelse[0]))):i.push(n.mkText(" else"),Pe(t.orelse))),i};return n.mkStmt(n.mkGroup(r(t)))},With:t=>{if(1==t.items.length&&function(e,t){let n=ke(e);return!(!n.classType||n.classType.pyQName!=t)||V(n)==t}(t.items[0].context_expr,"pins.I2CDevice")){let r=t.items[0],i=[],s=nt(r.context_expr);if(r.optional_vars){let e=Oe(r.optional_vars);if(e){let o=Q(e,{isLocal:!0}),a=null==o?void 0:o.symbol;e=De(e),i.push(n.mkStmt(n.mkText("const "+e+" = "),s)),a.pyRetType||H(t,9537,lf("function '{0}' missing return type",a.pyQName)),Z(r.context_expr,a.pyRetType),s=n.mkText(e)}}return i.push(n.mkStmt(n.mkInfix(s,".",n.mkText("begin()")))),e.U.pushRange(i,t.body.map(rt)),i.push(n.mkStmt(n.mkInfix(s,".",n.mkText("end()")))),n.mkGroup(i)}let r=[],i=t.items.map((e,t)=>{let i="with"+t;if(e.optional_vars){let t=Re(e.optional_vars);Q(t,{isLocal:!0}),i=De(t)}return r.push(n.mkStmt(n.mkText(i+".end()"))),n.mkStmt(n.mkText("const "+i+" = "),n.mkInfix(nt(e.context_expr),".",n.mkText("begin()")))});return e.U.pushRange(i,t.body.map(rt)),e.U.pushRange(i,r),n.mkBlock(i)},Raise:e=>{let t,r=e.exc||e.cause;if(!r)return n.mkStmt(n.mkText("throw"));if(r&&"Call"==r.kind){let e=r;1==e.args.length&&(t=nt(e.args[0]))}return t||(t=n.mkGroup([n.mkText("`"),nt(r),n.mkText("`")])),n.mkStmt(n.H.mkCall("control.fail",[t]))},Assert:e=>(e.msg||H(e,9537,lf("assert missing message")),n.mkStmt(n.H.mkCall("control.assert",[e.test,e.msg].filter(e=>!!e).map(nt)))),Import:e=>{for(let t of e.names)t.asname&&Q(t.asname,{expandsTo:t.name}),B(e,t.name);return n.mkText("")},ImportFrom:e=>{let t=[];for(let r of e.names)if("*"==r.name)e.module||H(e,9538,lf("import missing module name")),Q(e.module,{isImportStar:!0});else{let i=e.module+"."+r.name,s=K(i),o=r.asname||r.name;xe(s)?(Q(o,{isImport:s,expandsTo:i}),t.push(n.mkStmt(n.mkText(`import ${De(o)} = ${i}`)))):Q(o,{expandsTo:i})}return n.mkGroup(t)},ExprStmt:e=>{return"Str"==e.value.kind?((t=e.value.s).trim().split(/\n/).length<=1?t=t.trim():t+="\n",n.mkStmt(n.mkText("/** "+t+" */"))):n.mkStmt(nt(e.value));var t},Pass:e=>n.mkStmt(n.mkText("")),Break:e=>n.mkStmt(n.mkText("break")),Continue:e=>n.mkStmt(n.mkText("continue")),Delete:t=>(H(t,9550,e.U.lf("delete statements are unsupported")),g(t)),Try:e=>{let t=[n.mkText("try"),Pe(e.body.concat(e.orelse))];for(let r of e.handlers)t.push(n.mkText("catch ("),r.name?qe(r.name):n.mkText("_")),r.type&&t.push(n.mkText("/* instanceof "),nt(r.type),n.mkText(" */")),t.push(n.mkText(")"),Pe(r.body));return e.finalbody.length&&t.push(n.mkText("finally"),Pe(e.finalbody)),n.mkStmt(n.mkGroup(t))},AsyncFunctionDef:t=>(H(t,9551,e.U.lf("async function definitions are unsupported")),g(t)),AsyncFor:t=>(H(t,9552,e.U.lf("async for statements are unsupported")),g(t)),AsyncWith:t=>(H(t,9553,e.U.lf("async with statements are unsupported")),g(t)),Global:r=>{const i=M();q();for(const n of r.names){e.U.lookup(i.vars,n)||H(r,9521,e.U.lf("No binding found for global variable"));Q(n,{},t.VarModifier.Global).firstRefPos<r.startPos&&H(r,9522,e.U.lf("Variable referenced before global declaration"))}return n.mkStmt(n.mkText(""))},Nonlocal:r=>{const i=M(),s=q();for(const n of r.names){const o=ot(n,s);o&&o!==i&&o.vars[n].modifier!==t.VarModifier.Global||H(r,9523,e.U.lf("No binding found for nonlocal variable"));Q(n,{},t.VarModifier.NonLocal).firstRefPos<r.startPos&&H(r,9524,e.U.lf("Variable referenced before nonlocal declaration"))}return n.mkStmt(n.mkText(""))}};function Le(t){let r,i,o,a;if("Assign"===t.kind){if(1!=t.targets.length)return H(t,9553,e.U.lf("multi-target assignment statements are unsupported")),g(t);a=t.targets[0],o=t.value,r=null,i=null}else{if("AnnAssign"!==t.kind)return t;a=t.target,o=t.value||null,r=t.annotation,i=ve(r),Z(a,i)}let l,u="",c=!!o&&Me(o,"const"),p=Oe(a)||"";if(G()||s.currClass||s.currFun||"_"==p[0]||(u="export "),p&&s.currClass&&!s.currFun){c=!(!o||!s.currClass.isNamespace);let e=ce(s.currClass.symInfo,p,!0);if(e||H(t,9544,lf("cannot get class field")),0==m)return n.mkText("/* skip for now */");e.pyRetType||H(t,9539,lf("function '{0}' missing return type",e.pyQName)),Z(a,e.pyRetType),e.isInstance=!1,s.currClass.isNamespace&&(u=`export ${c?"const":"let"} `)}if(!o)return H(t,9555,e.U.lf("unable to determine value of assignment")),g(t);if(Z(a,ke(o)),c)return Q(Re(a),{}),/^static /.test(u)||/const/.test(u)||(u+="const "),n.mkStmt(n.mkText(u),n.mkInfix(nt(a),"=",nt(o)));if(!u&&"Tuple"==a.kind)return function(t,r,i){if(r.elts.filter(e=>"Name"!==e.kind).length)return H(t,9556,e.U.lf("non-trivial tuple assignment unsupported")),g(t);const s=r.elts.map(Oe).map(e=>e?q().vars[e]:void 0);if(s.some(e=>void 0!==(null==e?void 0:e.modifier))){const e=function(){const e=q();return void 0===e.nextHelperVariableId&&(e.nextHelperVariableId=0),"___tempvar"+e.nextHelperVariableId++}(),t=[n.mkStmt(n.mkInfix(n.mkGroup([n.mkText("let "),n.mkText(e)]),"=",nt(i)))];for(let i=0;i<s.length;i++){const s=o(r.elts[i]);t.push(n.mkStmt(n.mkInfix(s,"=",n.mkGroup([n.mkText(e),n.mkText(`[${i}]`)]))))}return n.mkGroup(t)}{let e=[n.mkText("let "),n.mkText("[")],t=r.elts.map(e=>e).map(e=>o(e,!0));return e.push(n.mkCommaSep(t)),e.push(n.mkText("]")),n.mkStmt(n.mkInfix(n.mkGroup(e),"=",nt(i)))}function o(e,t=!1){He(e,"identifierCompletion"),ke(e);Ye(e);return Fe(e,t)}}(t,a,o);if("Name"===a.kind){const e=q().vars[p],t=null==e?void 0:e.symbol;t&&4===t.kind&&void 0===e.modifier&&(void 0===e.firstAssignPos||e.firstAssignPos>a.startPos)&&(e.firstAssignPos=a.startPos,e.firstAssignDepth=s.blockDepth)}if(r&&i&&("NameConstant"===o.kind&&null===o.value||"List"===o.kind&&0===o.elts.length)){const e=V(i);l=n.mkInfix(nt(a),":",n.mkText(e))}return l||(l=nt(a)),n.mkStmt(n.mkText(u),n.mkInfix(l,"=",nt(o)))}function Fe(e,t=!1){var r,i;let o=e.id,a=de(o),l=null==a?void 0:a.symbol,u=q().vars[o],c=null==u?void 0:u.symbol;return void 0===e.isdef&&(!l||4===l.kind&&l!==c?(s.currClass&&!s.currFun?(e.isdef=!1,a=Q(o,{})):(e.isdef=!0,a=Q(o,{isLocal:!0})),l=a.symbol):e.isdef=!1,e.symbolInfo=l,e.tsType||H(e,9540,lf("definition missing ts type")),l.pyRetType||H(e,9568,lf("missing py return type")),ee(e,e.tsType,l.pyRetType)),e.isdef&&lt(a,q())&&(e.isdef=!1),Ze(a,e),e.isdef&&!t?n.mkGroup([n.mkText("let "),qe(o)]):!(null==l?void 0:l.namespace)||!(null==l?void 0:l.qName)||(null===(r=s.currClass)||void 0===r?void 0:r.isNamespace)&&(null===(i=s.currClass)||void 0===i?void 0:i.name)===(null==l?void 0:l.namespace)?qe(o):qe(l.qName)}function De(e){return n.isReservedWord(e)?e+"_":e||e}function Oe(e){var t;if("Name"==e.kind){let t=e.id,n=me(t),r=null==n?void 0:n.symbol;if(r){if(r.expandsTo)return r.expandsTo;if(s.currClass&&!s.currFun&&!(null==n?void 0:n.modifier)&&r.qName)return r.qName}return t}if("Attribute"==e.kind){let t=Oe(e.value);if(t)return t+"."+e.attr}if(ze(e)&&(null===(t=s.currClass)||void 0===t?void 0:t.baseClass))return s.currClass.baseClass.qName}function Re(e){let t=Oe(e);return t||H(null,9542,lf("Cannot get name of unknown expression kind '{0}'",e.kind)),t}function qe(e){return"self"==e?n.mkText("this"):n.mkText(De(e))}function Me(e,t){if("Call"!=e.kind)return!1;return Oe(e.func)===t}function Ge(t,r,i){let s=Ee[r];return e.U.assert(!!s),s.length>3?n.H.mkCall(s,[t,i]):n.mkInfix(t,s,i)}const Be={memoryview:{n:"",t:C},const:{n:"",t:S},"micropython.const":{n:"",t:S}};const Qe=function(){let e={};return Object.keys(pxtc.ts2PyFunNameMap).forEach(t=>{let n=pxtc.ts2PyFunNameMap[t];if(n&&n.n){let r={n:t,t:P(n.t),scale:n.scale};e[n.n]=r}}),Object.keys(Be).forEach(t=>{e[t]=Be[t]}),e}();function ze(e){return Me(e,"super")&&0==e.args.length}function We(e){return"Name"==e.kind&&"self"==e.id}function je(e){return e.type==n.NT.Prefix&&'"'==e.op[0]?n.mkText(n.backtickLit(JSON.parse(e.op))):e}function Ve(e){return c&&e.startPos<=c.position&&c.position<=e.endPos}function He(e,t){m>100&&c&&null==p&&(c.type==t||"symbol"==c.type)&&Ve(e)&&(p=e,f=q())}function Je(e,t){if(t&&t.pyAST&&"FunctionDef"==t.pyAST.kind){let n=t.pyAST;n.callers||(n.callers=[]),n.callers.indexOf(e)<0&&n.callers.push(e)}}const Xe={BoolOp:e=>{let t=nt(e.values[0]);for(let n=1;n<e.values.length;++n)t=Ge(t,e.op,nt(e.values[n]));return t},BinOp:e=>{let t=function(e){if("Mod"==e.op&&"Str"==e.left.kind&&("Tuple"==e.right.kind||"List"==e.right.kind)){let t=e.left.s,r=e.right.elts;r=r.slice();let i=[n.mkText("`")];return t.replace(/([^%]+)|(%[\d\.]*([a-zA-Z%]))/g,(e,t,s,o)=>{if(t)i.push(n.mkText(t.replace(/[`\\$]/g,e=>"\\"+e)));else{let e=r.shift(),t=e?nt(e):n.mkText("???");i.push(n.mkText("${"),t,n.mkText("}"))}return""}),i.push(n.mkText("`")),n.mkGroup(i)}return null}(e);if(t)return t;const r=nt(e.left),i=nt(e.right);return pt(e.left)&&pt(e.right)&&"Add"===e.op?n.H.extensionCall("concat",[r,i],!1):(t=Ge(r,e.op,i),be[e.op]&&(Z(e.left,S),Z(e.right,S),e.tsType||H(e,9570,lf("binary op missing ts type")),ee(e,e.tsType,S)),t)},UnaryOp:t=>{let r=Ce[t.op];return"Not"!==t.op?(Z(t,S),Z(t.operand,S)):Z(t,b),e.U.assert(!!r),n.mkInfix(null,r,nt(t.operand))},Lambda:t=>(H(t,9574,e.U.lf("lambda expressions are not supported yet")),h(t)),IfExp:e=>n.mkInfix(n.mkInfix(nt(e.test),"?",nt(e.body)),":",nt(e.orelse)),Dict:e=>{s.blockDepth++;const t=e.keys.map((t,r)=>{const i=e.values[r];return void 0===t?h(e):n.mkStmt(n.mkInfix(nt(t),":",nt(i)),n.mkText(","))}),r=n.mkBlock(t);return s.blockDepth--,r},Set:e=>h(e),ListComp:e=>h(e),SetComp:e=>h(e),DictComp:e=>h(e),GeneratorExp:e=>{if(1==e.generators.length&&"Comprehension"==e.generators[0].kind){let t=e.generators[0];if(0==t.ifs.length)return Te(()=>{let r=Re(t.target);return Q(r,{isParam:!0}),n.mkInfix(nt(t.iter),".",n.H.mkCall("map",[n.mkGroup([qe(r),n.mkText(" => "),nt(e.elt)])]))})}return h(e)},Await:e=>h(e),Yield:e=>h(e),YieldFrom:e=>h(e),Compare:e=>{if(1==e.ops.length&&("In"==e.ops[0]||"NotIn"==e.ops[0])){z(ke(e.comparators[0]))==v&&Z(e.left,v);let t=n.mkInfix(nt(e.comparators[0]),".",n.H.mkCall("indexOf",[nt(e.left)]));return n.mkInfix(t,"In"==e.ops[0]?">=":"<",n.mkText("0"))}let t=nt(e.left),r=nt(e.comparators[0]);const i=(e,i,s)=>{Ne[e]&&ft(i)&&ft(s)&&n.flattenNode([t])!==n.flattenNode([r])&&(t=n.H.mkParenthesizedExpression(n.mkGroup([t,n.mkText(" as any")])),r=n.H.mkParenthesizedExpression(n.mkGroup([r,n.mkText(" as any")])))};i(e.ops[0],e.left,e.comparators[0]);let s=Ge(t,e.ops[0],r);for(let n=1;n<e.ops.length;++n)t=nt(e.comparators[n-1]),r=nt(e.comparators[n]),i(e.ops[n],e.comparators[n-1],e.comparators[n]),s=Ge(s,"And",Ge(t,e.ops[n],r));return s},Call:t=>{var r,i,o,a,l;t.func.inCalledPosition=!0;let u,m,d=Oe(t.func),y=ye(d),k=y&&8==y.kind,x=y,T="";if(k)x=ye(y.pyQName+".__constructor"),x||(x=le(3,mt(null==y?void 0:y.pyAST)));else if("Attribute"==t.func.kind){let e=t.func;m=e.value,u=ke(m),(u.classType||u.primType)&&(T=e.attr,x=pe(m,T,!0),x&&(T=x.name))}let g=t.args.slice();if("super"==d&&0==g.length)return s.currClass&&s.currClass.baseClass&&(t.tsType||H(t,9543,lf("call expr missing ts type")),Y(t,t.tsType,s.currClass.baseClass)),n.mkText("super");if(Me(t,"int")&&1===g.length&&g[0]){const e=g[0],t=nt(e),r=ke(e);if("string"===r.primType)return n.mkGroup([n.mkText("parseInt"),n.mkText("("),t,n.mkText(")")]);if("number"===r.primType)return n.mkGroup([n.mkInfix(n.mkText("Math"),".",n.mkText("trunc")),n.mkText("("),t,n.mkText(")")])}if(!x){let t=e.U.lookup(Qe,d);if(t&&(T=""),T&&(d=V(u)+"."+T,t=e.U.lookup(Qe,d),t||"@array"!=J(z(u))||(d="Array."+T,t=e.U.lookup(Qe,d))),T="",t)if("."==t.n[0]&&g.length){if(m=g.shift(),u=ke(m),T=t.n.slice(1),x=pe(m,T),x&&2==x.kind)return n.mkInfix(nt(m),".",n.mkText(T))}else x=K(t.n)}if(Me(t,"str"))return ee(t,t.tsType,v),n.mkInfix(n.mkText('""'),"+",nt(t.args[0]));const h="Attribute"===t.func.kind&&ze(t.func.value);!x&&h&&(x=K(d));const S="__init__"===(null===(r=s.currFun)||void 0===r?void 0:r.name)&&"__constructor"===(null==x?void 0:x.name)&&(null===(o=null===(i=s.currClass)||void 0===i?void 0:i.baseClass)||void 0===o?void 0:o.pyQName)===(null==x?void 0:x.namespace)&&h;S&&(x=ye((null===(l=null===(a=s.currClass)||void 0===a?void 0:a.baseClass)||void 0===l?void 0:l.pyQName)+".__constructor")),x||H(t,9508,e.U.lf("can't find called function '{0}'",d));let b,N=x?x.parameters:null,C=[];if(N){for(g.length>N.length&&H(t,9510,e.U.lf("too many arguments in call to '{0}'",x.pyQName));g.length<N.length;)g.push(null);g=g.slice(0,N.length);for(let n of t.keywords){let t=N.findIndex(e=>e.name==n.arg);t<0?H(n,9511,e.U.lf("'{0}' doesn't have argument named '{1}'",x.pyQName,n.arg)):null!=g[t]?H(n,9512,e.U.lf("argument '{0} already specified in call to '{1}'",n.arg,x.pyQName)):g[t]=n.value}for(let e=g.length-1;e>=0&&(N[e].initializer&&null==g[e]);e--)g.pop();for(let r=0;r<g.length;++r){let i=g[r];if(null!=i||N[r].initializer)if(i){N[r].pyType||H(t,9545,lf("formal arg missing py type"));const e=N[r].pyType;"any"!==e.primType&&ne(i,e),"Name"==i.kind&&_e(i.symbolInfo)?C.push(Ke(i.symbolInfo.pyAST,!0)):C.push(nt(i))}else N[r].initializer||H(t,9547,lf("formal arg missing initializer")),C.push(n.mkText(N[r].initializer));else H(t,9513,e.U.lf("missing argument '{0}' in call to '{1}'",N[r].name,x.pyQName)),C.push(n.mkText("null"))}}else x&&H(t,9509,e.U.lf("calling non-function")),C=g.map(nt);if(!p&&c&&"signature"==c.type&&Ve(t)){p=t,f=q(),c.auxResult=0;for(let e=0;e<g.length;++e){c.auxResult=e;let t=g[e];if(!t)break;if(t.startPos<=c.position&&c.position<=t.endPos)break}}if(x)if(x.pyRetType||H(t,9549,lf("function missing pyRetType")),m&&pt(m)&&u?function(e,t,n){switch(t.qName){case"Array.pop":case"Array.removeAt":case"Array.shift":case"Array.find":case"Array.get":case"Array._pickRandom":Z(e,n.typeArgs[0]);break;case"Array.concat":case"Array.slice":case"Array.filter":case"Array.fill":Z(e,n);break;case"Array.reduce":if("Call"===e.kind&&e.args.length>1){const t=ke(e.args[1]);t&&Z(e,t)}break;case"Array.map":Z(e,L(E));break;default:Z(e,t.pyRetType)}}(t,x,u):Z(t,x.pyRetType),t.symbolInfo=x,x.attributes.py2tsOverride){const e=function(e){const t=new RegExp(/([^\$]*\()?([^\$\(]*)\$(\d)(?:(?:(?:=(\d+|'[a-zA-Z0-9_]*'|false|true|null|undefined))|(\?)|))/,"y"),n=[];let r,i=0;do{i=t.lastIndex,r=t.exec(e),r&&(r[1]&&n.push({kind:"text",text:r[1]}),n.push({kind:"arg",prefix:r[2],index:parseInt(r[3]),default:r[4],isOptional:!!r[5]}))}while(r);null!=i?n.push({kind:"text",text:e.substr(i)}):n.push({kind:"text",text:e});return{parts:n}}(x.attributes.py2tsOverride);if(e){T&&!m&&H(t,9550,lf("missing recv"));let r=function(e,t,r){const i=[];for(const r of e.parts)if("text"===r.kind)i.push(n.mkText(r.text));else if(t[r.index]||r.default)r.prefix&&i.push(n.mkText(r.prefix)),t[r.index]?i.push(t[r.index]):i.push(n.mkText(r.default));else if(!r.isOptional)return;if(r)return n.mkInfix(r,".",n.mkGroup(i));return n.mkGroup(i)}(e,C,T?nt(m):void 0);return r||H(t,9555,lf("buildOverride failed unexpectedly")),r}}else if(x.attributes.pyHelper)return n.mkGroup([n.mkInfix(n.mkText("_py"),".",n.mkText(x.attributes.pyHelper)),n.mkText("("),n.mkCommaSep(m?[nt(m)].concat(C):C),n.mkText(")")]);S?b=n.mkText("super"):T?(b=n.mkInfix(nt(m),".",n.mkText(T)),He(t.func,"memberCompletion")):b=nt(t.func);let U=[b,n.mkText("("),n.mkCommaSep(C),n.mkText(")")];return x&&1==C.length&&pxtc.service.isTaggedTemplate(x)&&(U=[b,je(C[0])]),k&&(y&&y.pyQName||H(t,9551,lf("missing namedSymbol or pyQName")),U[0]=n.mkText(j(y.pyQName)),U.unshift(n.mkText("new "))),n.mkGroup(U)},Num:e=>(e.tsType||H(e,9556,lf("tsType missing")),ee(e,e.tsType,S),n.mkText(e.ns)),Str:e=>(e.tsType||H(e,9557,lf("tsType missing")),ee(e,e.tsType,v),n.mkText(n.stringLit(e.s))),FormattedValue:e=>h(e),JoinedStr:e=>h(e),Bytes:t=>n.mkText(`hex\`${e.U.toHex(new Uint8Array(t.s))}\``),NameConstant:e=>(null!==e.value&&(e.tsType||H(e,9558,lf("tsType missing")),ee(e,e.tsType,b)),n.mkText(JSON.stringify(e.value))),Ellipsis:e=>h(e),Constant:e=>h(e),Attribute:t=>{let r=nt(t.value),i=ke(t.value),s=pe(t.value,t.attr),o=t.attr;if(He(t,"memberCompletion"),s)t.symbolInfo=s,Je(t,s),t.tsType&&s.pyRetType||H(t,9559,lf("tsType or pyRetType missing")),ee(t,t.tsType,s.pyRetType),o=s.name;else if(i.moduleType){let n=K(i.moduleType.pyQName+"."+t.attr);n?(t.symbolInfo=n,Je(t,n),Z(t,A(n)),o=n.name):H(t,9514,e.U.lf("module '{0}' has no attribute '{1}'",i.moduleType.pyQName,t.attr))}else m>2&&H(t,9515,e.U.lf("unknown object type; cannot lookup attribute '{0}'",t.attr));return n.mkInfix(r,".",n.mkText(De(o)))},Subscript:e=>{if("Index"==e.slice.kind){const t=z(ke(e.value));if(pt(e.value)){Z(e,t.typeArgs[0])}else"string"===t.primType?Z(e,t):m>2&&X(ke(e))&&Z(e,E);let r=e.slice.value;return m>2&&X(ke(r))&&Z(r,S),n.mkGroup([nt(e.value),n.mkText("["),nt(r),n.mkText("]")])}if("Slice"==e.slice.kind){const t=ke(e.value);Z(e,t);let r=e.slice;if(r.step){const i="string"===(null==t?void 0:t.primType);return n.H.mkCall(i?"_py.stringSlice":"_py.slice",[nt(e.value),r.lower?nt(r.lower):n.mkText("null"),r.upper?nt(r.upper):n.mkText("null"),nt(r.step)])}return n.mkInfix(nt(e.value),".",n.H.mkCall("slice",[r.lower?nt(r.lower):n.mkText("0"),r.upper?nt(r.upper):null].filter(T)))}return h(e)},Starred:e=>n.mkGroup([n.mkText("... "),nt(e.value)]),Name:e=>{if(He(e,"identifierCompletion"),"self"==e.id&&s.currClass)return e.tsType||H(e,9560,lf("missing tsType")),Y(e,e.tsType,s.currClass.symInfo),n.mkText("this");let t=Ye(e),r=null==t?void 0:t.symbol;if(r&&r.isImport)return qe(r.name);if(Ze(t,e),e.ctx.indexOf("Load")>=0){if(!r)return qe(Re(e));if(!(null==r?void 0:r.qName))return H(e,9561,lf("missing qName")),qe("unknown");return qe(r.qName.replace("@type",""))}return Fe(e)},List:et,Tuple:et};function Ye(t){let n=de(t.id),r=null==n?void 0:n.symbol;if(!n){let r=e.U.lookup(Qe,t.id);r&&(n=de(r.n))}if(n&&r){if(t.symbolInfo=r,t.tsType||H(t,9562,lf("missing tsType")),ee(t,t.tsType,A(r)),r.isImport)return n;Je(t,r),t.forTargetEndPos&&n.forVariableEndPos!==t.forTargetEndPos&&(n.forVariableEndPos?n.lastRefPos=n.forVariableEndPos+1:n.forVariableEndPos=t.forTargetEndPos)}else m>0&&H(t,9516,e.U.lf("name '{0}' is not defined",t.id));return n}function Ze(e,n){if(e){if(e.modifier===t.VarModifier.Global){const t=M();t&&t.vars[e.symbol.name]&&(e=t.vars[e.symbol.name])}else if(e.modifier===t.VarModifier.NonLocal){const t=ot(e.symbol.name,q());t&&(e=t.vars[e.symbol.name])}(void 0===e.firstRefPos||e.firstRefPos>n.startPos)&&(e.firstRefPos=n.startPos),(void 0===e.lastRefPos||e.lastRefPos<n.startPos)&&(e.lastRefPos=n.startPos)}}function et(e){return e.tsType||H(e,9563,lf("missing tsType")),ee(e,e.tsType,L(e.elts[0]?ke(e.elts[0]):$())),n.mkGroup([n.mkText("["),n.mkCommaSep(e.elts.map(nt)),n.mkText("]")])}function tt(e){return`${e.startPos}:${e.endPos}`}function nt(t){o=t;let n=Xe[t.kind];n||e.U.oops(t.kind+" - unknown expr"),ke(t);const r=n(t);return r.id=tt(t),r}function rt(t){o=t;let r=$e[t.kind];r||e.U.oops(t.kind+" - unknown stmt");let i=(t._comments||[]).map(e=>e.value),s=r(t);return i.length&&(s=n.mkGroup(i.map(e=>n.mkStmt(n.H.mkComment(e))).concat(s))),s.id=tt(t),s}function it(e){return!e||(e.type==n.NT.Prefix&&""==e.op?e.children.every(it):e.type==n.NT.NewLine)}function st(e){const t=qe(e.name),r=V(A(e));return n.mkStmt(n.mkGroup([n.mkText("let "),t,n.mkText(": "+r+";")]))}function ot(e,n){if(!n)return;const r=n.vars&&n.vars[e];return r&&r.modifier!=t.VarModifier.NonLocal?n:ot(e,n.parent)}function at(e){const t=[];let n;for(const r of Object.keys(e.vars))n=e.vars[r],lt(n,e)&&t.push(st(null==n?void 0:n.symbol));return t}function lt(e,t){let n=4===e.symbol.kind&&!e.symbol.isParam&&void 0===e.modifier&&(e.lastRefPos>e.forVariableEndPos||e.firstRefPos<e.firstAssignPos||e.firstAssignDepth>t.blockDepth)&&!(function(e){return"Module"===e.kind&&"main"===e.name}(t)&&0===e.firstAssignDepth);return!!n}function ut(t){if(e.U.assert("Module"==t.kind),t.tsBody)return;var r;s={currClass:void 0,currFun:void 0,currModule:r=t,blockDepth:0},a=r.tsFilename.replace(/\.ts$/,".py"),t.vars||(t.vars={});let i=at(t).concat(t.body.map(rt));return i.every(it)?void 0:"main"==t.name?i:[n.mkText("namespace "+t.name+" "),n.mkBlock(i)]}function ct(e){m=e,l=[],y=0,o=void 0}function pt(e){const t=z(ke(e));return t&&"@array"===t.primType}function ft(e){switch(e.kind){case"Num":case"Str":return!0;case"NameConstant":return null!==e.value}return!1}function mt(e,t=e.symInfo){var n;const r=_(t.pyQName+".__constructor");if(!r&&(null===(n=t.extendsTypes)||void 0===n?void 0:n.length)){const n=ye(t.extendsTypes[0])||K(t.extendsTypes[0]);if(n)return mt(e,n)}const i={kind:"FunctionDef",name:"__init__",startPos:e.startPos,endPos:e.endPos,parent:e,body:[],args:{kind:"Arguments",startPos:0,endPos:0,args:[{startPos:0,endPos:0,kind:"Arg",arg:"self"}],kw_defaults:[],kwonlyargs:[],defaults:[]},decorator_list:[],vars:{},symInfo:se(3,e.symInfo.qName+".__constructor")};return i.symInfo.parameters=[],i.symInfo.pyRetType=$({classType:e.symInfo}),r&&(i.args.args.push(...r.parameters.map(e=>({startPos:0,endPos:0,kind:"Arg",arg:e.name}))),i.symInfo.parameters.push(...r.parameters.map(e=>{if(e.pyType)return e;return Object.assign(Object.assign({},e),{pyType:w(e.type)})}))),i}function dt(e,t,r){const i=`___${t}_is_set`,s=`___${t}`;return n.mkStmt(n.mkStmt(n.mkText(`private ${i}: boolean`)),n.mkStmt(n.mkText(`private ${s}: ${r}`)),n.mkStmt(n.mkText(`get ${t}(): ${r}`),n.mkBlock([n.mkText(`return this.${i} ? this.${s} : ${e}.${t}`)])),n.mkStmt(n.mkText(`set ${t}(value: ${r})`),n.mkBlock([n.mkStmt(n.mkText(`this.${i} = true`)),n.mkStmt(n.mkText(`this.${s} = value`))])))}t.py2ts=function(s){let o=[];const m={};l=[],e.U.assert(!!s.sourceFiles,"missing sourceFiles! Cannot convert py to ts");let d=s.sourceFiles.filter(t=>e.U.endsWith(t,".py"));if(0==d.length)return{outfiles:m,diagnostics:l,success:0===l.length,sourceMap:[]};let k=(e,t)=>e.substr(0,e.length-t.length),x=e.U.toDictionary(d,e=>k(e,".py")),T=s.sourceFiles.filter(t=>e.U.endsWith(t,".ts")).filter(e=>k(e,".ts")in x);e.U.assert(!!s.apisInfo,"missing apisInfo! Cannot convert py to ts"),a=d[0],function(t,n){i={},r={};let s=e.U.toDictionary(n,e=>e);for(let n of e.U.values(t.byQName)){if(s.hasOwnProperty(n.fileName))continue;let t=n;t.extendsTypes&&(t.extendsTypes=t.extendsTypes.filter(e=>e!=t.qName)),t.pyQName&&t.qName||H(null,9526,e.U.lf("Symbol '{0}' is missing qName for '{1}'",t.name,t.pyQName?"ts":"py")),r[t.pyQName]=t,r[t.qName]=t}C=w("Buffer")}(s.apisInfo,T),u=s,c=void 0,s.generatedFiles||(s.generatedFiles=[]);for(const P of d){let A=P,_=P.replace(/\.py$/,"").replace(/.*\//,""),K=s.fileSystem[P];try{a=P;let $=e.py.lex(K),L=e.py.parse(K,A,$);e.U.pushRange(l,L.diagnostics),o.push({kind:"Module",body:L.stmts,blockDepth:0,name:_,source:K,tsFilename:A.replace(/\.py$/,".ts")})}catch(F){e.log("Parse error",F)}}const g=l;for(let D=0;D<5;++D){ct(D);for(let O of o)try{ut(O)}catch(R){e.log("Conv pass error",R)}if(0==y)break}ct(1e3),p=void 0,c=s.syntaxInfo||{position:0,type:"symbol"};let h=[];for(let q of o)try{let M=ut(q);if(!M)continue;let G=n.flattenNode(M);function v(e){let t=e.id.split(":");if(2!=t.length)return;let n=t.map(e=>parseInt(e));return{py:{startPos:n[0],endPos:n[1]},ts:{startPos:e.startPos,endPos:e.endPos}}}s.sourceFiles.push(q.tsFilename),s.generatedFiles.push(q.tsFilename),s.fileSystem[q.tsFilename]=G.output,m[q.tsFilename]=G.output,h=G.sourceMap.map(v).filter(e=>!!e)}catch(B){e.log("Conv error",B)}l=g.concat(l);let S={};const b=e.U.values(r).concat(e.U.values(i));let N=[];const E=e=>{if((e=>{switch(e.kind){case 6:case 7:case 4:case 3:case 5:return!0;case 2:case 1:return!e.isInstance;default:return!1}})(e)&&N.indexOf(e)<0){let t=I(e);S[t.qName||t.name]=t}};for(let Q=f;Q;Q=Q.parent)Q&&Q.vars&&e.U.values(Q.vars).map(e=>e.symbol).forEach(E);if(b.forEach(E),c&&p){if(c.beginPos=p.startPos,c.endPos=p.endPos,c.symbols||(c.symbols=[]),N=c.symbols.slice(),"memberCompletion"==c.type&&"Attribute"==p.kind){const z=ke(p.value);if(z.moduleType)for(let W of b)W.isInstance||W.namespace!=z.moduleType.qName||c.symbols.push(W);else if(z.classType||z.primType){const j=z.classType||fe(z.primType).reduce((e,t)=>e||t,null);if(j){j.extendsTypes&&j.qName||H(null,9567,lf("missing extendsTypes or qName"));let V=j.extendsTypes.concat(j.qName);for(let J of b)J.isInstance&&V.indexOf(J.namespace)>=0&&c.symbols.push(J)}}}else if("identifierCompletion"==c.type)c.symbols=e.U.values(S);else{let X=p.symbolInfo;X&&c.symbols.push(X)}c.symbols=c.symbols.map(I)}let U=function(){for(let e of l)t.patchPosition(e,s.fileSystem[e.fileName]);return l}();return{outfiles:m,success:0===U.length,diagnostics:U,syntaxInfo:c,globalNames:S,sourceMap:h}}}(e.py||(e.py={}))}(pxt||(pxt={})),function(e){!function(t){let n;!function(e){e[e.Id=0]="Id",e[e.Op=1]="Op",e[e.Keyword=2]="Keyword",e[e.Number=3]="Number",e[e.String=4]="String",e[e.NewLine=5]="NewLine",e[e.Comment=6]="Comment",e[e.Indent=7]="Indent",e[e.Dedent=8]="Dedent",e[e.EOF=9]="EOF",e[e.Error=10]="Error"}(n=t.TokenType||(t.TokenType={})),t.keywords={False:!0,None:!0,True:!0,and:!0,as:!0,assert:!0,async:!0,await:!0,break:!0,class:!0,continue:!0,def:!0,del:!0,elif:!0,else:!0,except:!0,finally:!0,for:!0,from:!0,global:!0,if:!0,import:!0,in:!0,is:!0,lambda:!0,nonlocal:!0,not:!0,or:!0,pass:!0,raise:!0,return:!0,try:!0,while:!0,with:!0,yield:!0};let r,i,s=[];const o={"%":"Mod","&":"BitAnd","*":"Mult","**":"Pow","+":"Add","-":"Sub","/":"Div","//":"FloorDiv","<<":"LShift",">>":"RShift","@":"MatMult","^":"BitXor","|":"BitOr"},a={"!":"Bang","!=":"NotEq","(":"LParen",")":"RParen",",":"Comma","->":"Arrow",".":"Dot",":":"Colon",";":"Semicolon","<":"Lt","<=":"LtE","=":"Assign","==":"Eq",">":"Gt",">=":"GtE","[":"LSquare","]":"RSquare","{":"LBracket","}":"RBracket","~":"Invert"},l={b:/^[_0-1]$/,B:/^[_0-1]$/,o:/^[_0-7]$/,O:/^[_0-7]$/,x:/^[_0-9a-fA-F]$/,X:/^[_0-9a-fA-F]$/},u={b:2,B:2,o:8,O:8,x:16,X:16};let c,p,f=0,m=0;function d(e,t){let n=0,r=0;for(let i=0;i<e;++i)10==t.charCodeAt(i)&&(n++,r=i);return{line:n,column:e-r-1}}function y(e){switch(e.type){case n.Id:return`id(${e.value})`;case n.Op:return"'"+i[e.value]+"'";case n.Keyword:return e.value;case n.Number:return`num(${e.value})`;case n.String:return e.stringPrefix+JSON.stringify(e.value);case n.NewLine:return"<nl>";case n.Comment:return`/* ${e.value} */`;case n.Indent:return"indent"+e.value;case n.Dedent:return"dedent";case n.Error:return`[ERR: ${e.value}]`;case n.EOF:return"End of file";default:return"???"}}t.position=d,t.patchPosition=function(e,t){if(!e.start&&!e.length)return e.start=0,e.length=0,e.line=0,void(e.column=0);let n=d(e.start,t);e.line=n.line,e.column=n.column,e.length>0&&(n=d(e.start+e.length-1,t),e.endLine=n.line,e.endColumn=n.column+2)},t.tokenToString=y,t.friendlyTokenToString=function(e,t){let n=e.endPos-e.startPos,r="";return r=0==n?y(e):n>20?"`"+t.slice(e.startPos,e.startPos+20)+"`...":"`"+t.slice(e.startPos,e.endPos)+"`",r=r.replace(/\r/g,"").replace(/\n/g,"\\n").replace(/\t/g,"\\t"),r},t.tokensToString=function(e){let t="",r=0;for(let i of e){let e=y(i);r+e.length>70&&(r=0,t+="\n"),0!=r&&(t+=" "),t+=e,r+=e.length,i.type!=n.NewLine&&i.type!=n.Comment||(r=0,t+="\n")}return t},t.lex=function(d){for(0==s.length&&function(){const n={'"':b,"'":b,"#":U,"\\":C,".":I};r=e.U.clone(a);for(let e of Object.keys(o))r[e]=o[e],r[e+"="]=o[e]+"Assign";i={};for(let e of Object.keys(r))i[r[e]]=e;for(let e=0;e<128;++e)if(t.rx.isIdentifierStart(e))s[e]=x;else{let i=String.fromCharCode(e);if(n.hasOwnProperty(i))s[e]=n[i];else if(r.hasOwnProperty(i)){let t=!1,n=r[i];for(let e of Object.keys(r))e!=i&&e.startsWith(i)&&(t=!0);s[e]=t?()=>g(n):()=>T(n)}else t.rx.isSpace(e)?s[e]=()=>{}:13==e?s[e]=()=>{10==p.charCodeAt(f)&&f++,N()}:t.rx.isNewline(e)?s[e]=N:w(e)?s[e]=P:s[e]=A}}(),p=d,c=[],f=0,m=0,E();f<p.length;){m=f;const e=p.charCodeAt(f++);e<128?s[e]():t.rx.isIdentifierStart(e)?x():t.rx.isSpace(e)||(t.rx.isNewline(e)?N():A())}return m=f,N(),y(n.EOF,""),c;function y(e,t,n){let r={type:e,value:t,startPos:m,endPos:f,auxValue:n};return c.push(r),r}function k(e){y(n.Error,e)}function x(){for(;t.rx.isIdentifierChar(p.charCodeAt(f));)f++;let e=p.slice(m,f),r=p.charCodeAt(f);t.keywords.hasOwnProperty(e)?y(n.Keyword,e):34==r||39==r?S(e):y(n.Id,e)}function T(e){y(n.Op,e)}function g(e){let t=p.slice(m,f+1);if(2==t.length&&r.hasOwnProperty(t)){let n=p.slice(m,f+2);3==n.length&&r.hasOwnProperty(n)?(f+=2,e=r[n]):(f++,e=r[t])}T(e)}function h(e){switch(e){case 97:return 7;case 98:return 8;case 102:return 12;case 110:return 10;case 114:return 13;case 116:return 9;case 118:return 11;default:return 0}}function v(e){return("0000"+e.toString(16)).slice(-4)}function S(r){const i=p.charCodeAt(f++);let s=!1;p.charCodeAt(f)==i&&p.charCodeAt(f+1)==i&&(f+=2,s=!0);let o=(r=r.toLowerCase()).indexOf("r")>=0,a="",l="";for(;;){const n=p.charCodeAt(f++);if(n==i){if(!s)break;if(p.charCodeAt(f)==i&&p.charCodeAt(f+1)==i){f+=2;break}l+="\\"+String.fromCharCode(i),a+=String.fromCharCode(i)}else if(92==n){let n=p.charCodeAt(f++);if(13==n&&10==p.charCodeAt(f)&&(n=10,f++),34==n||39==n||92==n)o&&(l+="\\",a+="\\"),l+="\\"+String.fromCharCode(n),a+=String.fromCharCode(n);else if(!o&&h(n))l+="\\"+String.fromCharCode(n),a+=String.fromCharCode(h(n));else if(t.rx.isNewline(n))o&&(a+="\\"+String.fromCharCode(n),l+="\\\\",l+=10==n?"\\n":"\\u"+v(n));else if(o||48!=n)if(o||117!=n&&120!=n)l+="\\\\"+String.fromCharCode(n),a+="\\"+String.fromCharCode(n);else{let t=117==n?4:2,r=p.slice(f,f+t);f+=t;let i=parseInt(r,16);isNaN(i)&&k(e.U.lf("invalid unicode or hex escape")),l+="\\"+String.fromCharCode(n)+r,a+=String.fromCharCode(i)}else l+="\\\\x00",a+="\0"}else{if(isNaN(n)){k(e.U.lf("end of file in a string"));break}if(t.rx.isNewline(n)&&!s){k(e.U.lf("new line in a string"));break}a+=String.fromCharCode(n),l+=String.fromCharCode(n)}}let u=y(n.String,a);u.quoted=l,u.stringPrefix=r}function b(){f--,S("")}function N(){y(n.NewLine,""),E()}function E(){let e=0;for(;;){const t=p.charCodeAt(f);if(9!=t){if(32!=t)break;e++,f++}else e=e+8&-8,f++}y(n.Indent,""+e)}function C(){let n=p.charCodeAt(f);t.rx.isNewline(n)?(f++,13==n&&10==p.charCodeAt(f)&&f++):k(e.U.lf("unexpected character after line continuation character"))}function U(){for(y(n.NewLine,"");f<p.length&&!t.rx.isNewline(p.charCodeAt(f));)f++;y(n.Comment,p.slice(m+1,f)),13==p.charCodeAt(f)&&10==p.charCodeAt(f+1)&&f++,f++,E()}function P(){let t=p[m],r="";if("0"==t){let i=p[f];const s=l[i];if(s){for(f++;;){const e=p[f];if(!s.test(e))break;r+=e,f++}if(r){let s=parseInt(r,u[i]);isNaN(s)&&k(e.U.lf("invalid number")),y(n.Number,t+i+r,s)}else k(e.U.lf("expecting numbers to follow 0b, 0o, 0x"));return}}let i=!1,s=!1,o=!1;for(f=m;;){const e=p.charCodeAt(f);if(!o||43!=e&&45!=e)if(o=!1,95==e||w(e));else if(s||i||46!=e){if(s||69!=e&&101!=e)break;s=!0,o=!0}else i=!0;else;r+=String.fromCharCode(e),f++}!i&&!s&&"0"==t&&r.length>1&&!/^0+/.test(r)&&k(e.U.lf("unexpected leading zero"));let a=parseFloat(r);isNaN(a)&&k(e.U.lf("invalid number")),y(n.Number,r,a)}function I(){w(p.charCodeAt(f))?P():y(n.Op,"Dot")}function w(e){return 48<=e&&e<=57}function A(){k(e.U.lf("invalid token"))}}}(e.py||(e.py={}))}(pxt||(pxt={})),function(e){!function(t){let n,r,i,s,o,a,l,u,c;function p(){return r[o]}function f(){for(;r[o];o++){let i=r[o];if(i.type!=t.TokenType.Comment){if(n>=0&&i.type==t.TokenType.Op)switch(i.value){case"LParen":case"LSquare":case"LBracket":n++;break;case"RParen":case"RSquare":case"RBracket":n--}if(i.type!=t.TokenType.Error){if(n>0){if(i.type==t.TokenType.NewLine||i.type==t.TokenType.Indent)continue}else if(i.type==t.TokenType.Indent){if(r[o+1].type==t.TokenType.NewLine){o++;continue}let n=parseInt(i.value),s=l[l.length-1];if(n==s)continue;if(n>s)return void l.push(n);{i.type=t.TokenType.Dedent;let s=0;for(;l.length;){let t=l[l.length-1];if(!(t>n)){for(t!=n&&d(9552,e.U.lf("inconsitent indentation"));s>1;)r.splice(o,0,i),s--;return}l.pop(),s++}}}return}d(9551,i.value)}else a.push(i)}}function m(){u=p(),u.type!=t.TokenType.EOF&&(o++,f())}function d(n,r){r||(r=e.U.lf("invalid syntax")),n||(n=9550);const o=p(),a={code:n,category:pxtc.DiagnosticCategory.Error,messageText:e.U.lf("{0} near {1}",r,t.friendlyTokenToString(o,i)),fileName:s,start:o.startPos,length:o.endPos?o.endPos-o.startPos:0,line:0,column:0};t.patchPosition(a,i),c.push(a),9572!=n&&c.length>100&&e.U.userError(e.U.lf("too many parse errors"))}function y(n,r){const i=p();(i.type==n&&i.value==r||(d(9553,e.U.lf("expecting {0}",t.tokenToString(function(e,t){return{type:e,value:t,startPos:0,endPos:0}}(n,r)))),i.type!=t.TokenType.NewLine))&&m()}function k(){y(t.TokenType.NewLine,"")}function x(e){y(t.TokenType.Keyword,e)}function T(e){y(t.TokenType.Op,e)}function g(){let e=p();return e.type==t.TokenType.Keyword?e.value:""}function h(){let e=p();return e.type==t.TokenType.Op?e.value:""}const v={if:function e(){let t=N("If");m(),t.test=W(),t.body=b(),"elif"==g()?t.orelse=[e()]:t.orelse=C();return E(t)},while:function(){let e=N("While");return x("while"),e.test=W(),e.body=b(),e.orelse=C(),E(e)},for:function(){let e=N("For");return x("for"),e.target=R(),q(e.target),x("in"),e.iter=O(),e.body=b(),e.orelse=C(),E(e)},try:function(){let e=N("Try");x("try"),e.body=b(),e.handlers=[];let t=!1;for(;"except"==g();){let n=N("ExceptHandler");e.handlers.push(n),m(),"Colon"!=h()?(t&&d(),n.type=W(),"as"==g()?(m(),n.name=ge()):n.name=void 0):(t=!0,n.type=void 0,n.name=void 0),n.body=b()}e.orelse=C(),0==e.handlers.length&&e.orelse.length&&d();"finally"==g()?(m(),e.finalbody=b()):e.finalbody=[];return E(e)},with:function(){let t=N("With");return x("with"),t.items=ke(e.U.lf("with item"),U),t.body=b(),E(t)},def:function(){let e=N("FunctionDef");x("def"),e.name=ge(),T("LParen"),e.args=Q(!0),T("RParen"),e.returns=void 0,"Arrow"==h()&&(m(),e.returns=W());return e.body=b(),E(e)},class:function(){let e=N("ClassDef");if(x("class"),e.name=ge(),"LParen"==h()){let t=he();e.bases=t.args,e.keywords=t.keywords}else e.bases=[],e.keywords=[];return e.body=b(),E(e)}},S={del:function(){let t=N("Delete");return x("del"),t.targets=ye(e.U.lf("expression"),oe),E(t)},pass:function(){let e=N("Pass");return x("pass"),E(e)},break:function(){let e=N("Break");return m(),E(e)},continue:function(){let e=N("Continue");return m(),E(e)},return:function(){let e=N("Return");m(),I()?e.value=void 0:e.value=O();return E(e)},raise:function(){let e=N("Raise");x("raise"),e.exc=void 0,e.cause=void 0,I()||(e.exc=W(),"from"==g()&&(m(),e.cause=W()));return E(e)},global:w,nonlocal:function(){let e=w();return e.kind="Nonlocal",e},import:function(){let t=N("Import");return m(),t.names=ke(e.U.lf("import name"),_),E(t)},from:function(){let n=N("ImportFrom");m(),n.level=$(),p().type==t.TokenType.Id?n.module=A():n.module=void 0;n.level||n.module||d();if(x("import"),"Mult"==h()){m();let e=N("Alias");e.name="*",n.names=[e]}else"LParen"==h()?(m(),n.names=ye(e.U.lf("import name"),K),T("RParen")):n.names=ye(e.U.lf("import name"),K);return E(n)},assert:function(){let e=N("Assert");m(),e.test=W(),"Comma"==h()?(m(),e.msg=W()):e.msg=void 0;return E(e)},yield:function(){p();if(m(),"from"==g()){let e=N("YieldFrom");return e.value=W(),P(E(e))}let e=N("Yield");I()||(e.value=O());return P(E(e))}};function b(){return T("Colon"),function(){if(p().type==t.TokenType.NewLine){let n;if(m(),p().type!=t.TokenType.Indent)d(9554,e.U.lf("expected an indented block")),n=B();else{const r=parseInt(p().value);for(m(),n=B();;){if(p().type==t.TokenType.Dedent){const e=isNaN(r)||parseInt(p().value)<r;if(m(),e)break}if(e.U.pushRange(n,B()),p().type==t.TokenType.EOF)break}}return n}return G()}()}function N(e,t){let n=t||p();return{startPos:n.startPos,endPos:n.endPos,kind:e}}function E(e){return e.endPos=u.endPos,e}function C(){return"else"==g()?(m(),b()):[]}function U(){let e=N("WithItem");return e.context_expr=W(),e.optional_vars=void 0,"as"==g()&&(m(),e.optional_vars=oe()),E(e)}function P(e){let t=N("ExprStmt");return t.startPos=e.startPos,t.endPos=e.endPos,t.value=e,t}function I(){let e=p();return e.type==t.TokenType.NewLine||e.type==t.TokenType.Op&&"Semicolon"==e.value}function w(){let e=N("Global");for(m(),e.names=[];e.names.push(ge()),"Comma"==h();)m();return E(e)}function A(){let e="";for(;;){if(e+=ge(),"Dot"!=h())return e;e+=".",m()}}function _(){let e=N("Alias");return e.name=A(),"as"==g()?(m(),e.asname=ge()):e.asname=void 0,E(e)}function K(){let e=N("Alias");return e.name=ge(),"as"==g()?(m(),e.asname=ge()):e.asname=void 0,E(e)}function $(){let e=0;for(;;)if("Dot"==h())e+=1,m();else{if("Ellipsis"!=h())return e;e+=3,m()}}function L(e,t){let n=N("Tuple",e);return n.elts=t,E(n)}function F(t){let n=p(),r=ye(e.U.lf("expression"),t),i=r[0];return 1!=r.length?L(n,r):i}function D(){return F(le)}function O(){return F(W)}function R(){return F(oe)}function q(e){if("Tuple"==e.kind){e.elts.forEach(q)}else e.ctx="Store"}function M(){let n=e.U.lookup(S,g());return n?n():function(){let n=p(),r=D(),i=h();if("Assign"==i){let e=N("Assign");for(e.targets=[r];;){if(m(),r=D(),i=h(),"Assign"!=i){e.value=r;break}e.targets.push(r)}return e.targets.forEach(q),E(e)}if("Colon"==i){let e=N("AnnAssign");return e.target=r,m(),e.annotation=W(),"Assign"==h()&&(m(),e.value=W()),e.simple=n.type==t.TokenType.Id&&"Name"==r.kind?1:0,q(e.target),E(e)}if(e.U.endsWith(i,"Assign")){let e=N("AugAssign");return e.target=r,e.op=i.replace("Assign",""),m(),e.value=O(),q(e.target),E(e)}if("Semicolon"==i||p().type==t.TokenType.NewLine){let e=N("ExprStmt");return e.value=r,E(e)}return d(9555,e.U.lf("unexpected token")),m(),null}()}function G(){let e=[M()];for(;"Semicolon"==h()&&(m(),p().type!=t.TokenType.NewLine);)e.push(M());return k(),e.filter(e=>!!e)}function B(){const r=c.length,i=p().type==t.TokenType.Indent;i&&(m(),d(9573,e.U.lf("unexpected indent")));let s=[];for(;"MatMult"==h();)m(),s.push(Se()),k();let o=g(),l=e.U.lookup(v,g()),f=[],y=a;if(a=[],"class"==o||"def"==o){let e=l();e.decorator_list=s,f=[e]}else s.length?d(9556,e.U.lf("decorators not allowed here")):f=l?[l()]:G();y.length&&f.length&&(f[0]._comments=y);if(c.length>r){for(n=-1;u.type!=t.TokenType.Dedent&&u.type!=t.TokenType.NewLine&&(m(),p().type!=t.TokenType.EOF););i&&p().type===t.TokenType.Dedent&&m(),n=0}return f}function Q(n){let r=N("Arguments");for(r.args=[],r.defaults=[],r.kwonlyargs=[],r.kw_defaults=[],r.vararg=void 0;;){let n=h();if("Colon"==n||"RParen"==n)break;if("Mult"==n)r.vararg&&d(9557,e.U.lf("multiple *arg")),m(),p().type==t.TokenType.Id?r.vararg=i():r.vararg=void 0;else if("Pow"==n)r.kwarg&&d(9558,e.U.lf("multiple **arg")),m(),r.kwarg=i();else{r.kwarg&&d(9559,e.U.lf("arguments after **"));let t,n=i();"Assign"==h()&&(m(),t=W()),void 0!==r.vararg&&t?(r.kwonlyargs.push(n),r.kw_defaults.push(t)):(r.args.push(n),t?r.defaults.push(t):r.defaults.length&&d(9560,e.U.lf("non-default argument follows default argument")))}if("Comma"!=h())break;m()}return r.kwarg||(r.kwarg=void 0),r.vararg||(r.vararg=void 0),E(r);function i(){let e=N("Arg");return e.arg=ge(),e.annotation=void 0,n&&"Colon"==h()&&(m(),e.annotation=W()),e}}function z(e){let t=N("Lambda");return m(),t.args=Q(!1),T("Colon"),t.body=e?ue():W(),E(t)}function W(){if("lambda"==g())return z();let e=p(),t=H();if("if"==g()){let n=N("IfExp",e);return n.body=t,x("if"),n.test=H(),x("else"),n.orelse=W(),E(n)}return t}function j(e,t){let n=p(),r=t();if(g()==e){let i=N("BoolOp",n);for(i.op="or"==e?"Or":"And",i.values=[r];g()==e;)x(e),i.values.push(t());return E(i)}return r}function V(){return j("and",J)}function H(){return j("or",V)}function J(){if("not"==g()){let e=N("UnaryOp");return m(),e.op="Not",e.operand=J(),E(e)}return function(){let e=p(),t=oe();if(!Y())return t;let n=N("Compare",e);n.left=t,n.comparators=[],n.ops=[];for(;;){let e=Y();if(!e)break;m(),"NotIn"==e?x("in"):"Is"==e&&"not"==g()&&(m(),e="IsNot"),n.ops.push(e),n.comparators.push(oe())}return E(n)}()}const X={Lt:"Lt",Gt:"Gt",Eq:"Eq",GtE:"GtE",LtE:"LtE",NotEq:"NotEq",in:"In",not:"NotIn",is:"Is"};function Y(){return X[h()]||X[g()]||null}const Z={Invert:"Invert",Sub:"USub",Add:"UAdd"};function ee(e,t){let n=p(),r=e();for(;;){let i=h();if(!(i&&t.indexOf(","+i+",")>=0))return r;{let t=N("BinOp",n);t.left=r,t.op=i,m(),t.right=e(),r=t}}}function te(){return ee(be,",Mult,MatMult,Div,Mod,FloorDiv,")}function ne(){return ee(te,",Add,Sub,")}function re(){return ee(ne,",LShift,RShift,")}function ie(){return ee(re,",BitAnd,")}function se(){return ee(ie,",BitXor,")}function oe(){return ee(se,",BitOr,")}function ae(){let t,n=p();if("Colon"!=h()&&(t=W()),"Colon"==h()){let e=N("Slice",n);e.lower=t,m();let r=h();return e.upper="Colon"!=r&&"Comma"!=r&&"RSquare"!=r?W():void 0,e.step=void 0,"Colon"==h()&&(m(),r=h(),"Comma"!=r&&"RSquare"!=r&&(e.step=W())),E(e)}{t||d(9570,e.U.lf("unable to parse lower subscript"));let n=N("Index");return n.value=t,E(n)}}function le(){if("Mult"==h()){let e=N("Starred");return e.value=oe(),E(e)}return W()}function ue(){return"lambda"==g()?z(!0):H()}function ce(){let e=[];for(;;){let t=N("Comprehension");for(t.is_async=0,e.push(t),x("for"),t.target=R(),q(t.target),x("in"),t.iter=H(),t.ifs=[];"if"==g();)m(),t.ifs.push(ue());if("for"!=g())return e}}function pe(){let t=p();if("Mult"==h()){let e=N("Starred");return m(),e.value=W(),E(e)}if("Pow"==h()){let e=N("Keyword");return m(),e.arg=void 0,e.value=W(),E(e)}let n=W();if("Assign"==h()){"Name"!=n.kind&&d(9561,e.U.lf("invalid keyword argument; did you mean ==?")),m();let r=N("Keyword",t);return r.arg=n.id||"???",r.value=W(),E(r)}if("for"==g()){let e=N("GeneratorExp",t);return e.elt=n,e.generators=ce(),E(e)}return n}function fe(){let e=N("NameConstant");return e.value=null,m(),E(e)}function me(){let n=p();if(n.type==t.TokenType.Id){let e=N("Name");return m(),e.id=n.value,e.ctx="Load",E(e)}if(n.type==t.TokenType.Number){let e=N("Num");return m(),e.ns=n.value,e.n=n.auxValue,E(e)}if(n.type==t.TokenType.String){m();let r=n.value;for(;p().type==t.TokenType.String;)r+=p().value,m();if("b"==n.stringPrefix){let t=N("Bytes",n);return t.s=e.U.toArray(e.U.stringToUint8Array(r)),E(t)}{let e=N("Str",n);return e.s=r,E(e)}}if(n.type==t.TokenType.Keyword){if("None"==n.value||"True"==n.value||"False"==n.value){let e=N("NameConstant");return m(),e.value="True"==n.value||"False"!=n.value&&null,E(e)}return d(9564,e.U.lf("expecting atom")),fe()}if(n.type==t.TokenType.Op){let t=n.value;return"LParen"==t?Te("RParen","Tuple","GeneratorExp"):"LSquare"==t?Te("RSquare","List","ListComp"):"LBracket"==t?function(){let t=p();if(m(),"Pow"==h())return m(),r(void 0,oe());if("RBracket"==h()){let e=N("Dict",t);return m(),e.keys=[],e.values=[],E(e)}{let n=le();return"Starred"!=n.kind&&"Colon"==h()?(m(),r(n,W())):function(n){if("for"==g()){"Starred"==n.kind&&d(9562,e.U.lf("iterable unpacking cannot be used in comprehension"));let r=N("SetComp",t);return r.elt=n,r.generators=ce(),E(r)}let r=N("Set",t);if(r.elts=[n],"Comma"==h()){let t=xe("RBracket",e.U.lf("set element"),le);r.elts=[n].concat(t)}else T("RBracket");return E(r)}(n)}function n(){if("Pow"==h())return m(),[null,oe()];{let e=W();return T("Colon"),[e,W()]}}function r(r,i){if("for"==g()){r||d(9563,e.U.lf("dict unpacking cannot be used in dict comprehension"));let n=N("DictComp",t);return n.key=r,n.value=i,n.generators=ce(),E(n)}let s=N("Dict",t);if(s.keys=[r],s.values=[i],"Comma"==h()){let t=xe("RBracket",e.U.lf("dict element"),n);for(let e of t)e.length>=2&&e[0]&&e[1]&&(s.keys.push(e[0]),s.values.push(e[1]))}else T("RBracket");return E(s)}}():(d(9565,e.U.lf("unexpected operator")),fe())}return d(9566,e.U.lf("unexpected token")),fe()}function de(){let n=h();return"RParen"==n||"RSquare"==n||"RBracket"==n||"Colon"==n||"Semicolon"==n||(!!e.U.endsWith(n,"Assign")||("in"==g()||p().type==t.TokenType.NewLine))}function ye(t,n){let r=[];if(de())return r;for(;;){r.push(n());let i="Comma"==h();if(i&&m(),de())return r;if(!i)return d(9567,e.U.lf("expecting {0}",t)),r}}function ke(e,t){let n=[];for(;n.push(t()),"Comma"==h();)m();return n}function xe(t,n,r){m();let i=[];if(h()!=t)for(;;){i.push(r());let s="Comma"==h();if(s&&m(),h()==t)break;if(!s){d(9568,e.U.lf("expecting {0}",n));break}}return T(t),i}function Te(t,n,r){let i=p();if(m(),h()==t){m();let e=N(n,i);return e.elts=[],E(e)}let s=le();if("for"==g()){let e=N(r,i);return e.elt=s,e.generators=ce(),T(t),E(e)}if("Comma"==h()){let r=N(n,i);return m(),r.elts=ye(e.U.lf("expression"),le),r.elts.unshift(s),T(t),E(r)}if(T(t),"List"==n){let e=N(n,i);return e.elts=[s],E(e)}return s}function ge(){let n=p();return n.type!=t.TokenType.Id&&d(9569,e.U.lf("expecting identifier")),m(),n.value}function he(){let t=xe("RParen",e.U.lf("argument"),pe),n=[],r=[];for(let i of t)"Keyword"==i.kind?r.push(i):(r.length&&d(9570,e.U.lf("positional argument follows keyword argument")),n.push(i));return{args:n,keywords:r}}function ve(t,n){let r=h();if("LParen"==r){let e=N("Call",t);e.func=n;let r=he();return e.args=r.args,e.keywords=r.keywords,E(e)}if("LSquare"==r){let r=p(),i=N("Subscript",t);i.value=n;let s=xe("RSquare",e.U.lf("subscript"),ae);if(0==s.length)d(9571,e.U.lf("need non-empty index list"));else if(1==s.length)i.slice=s[0];else if(s.every(e=>"Index"==e.kind)){let e=s[0];e.value=L(r,s.map(e=>e.value)),i.slice=e}else{let e=N("ExtSlice",r);e.dims=s,i.slice=E(e)}return E(i)}if("Dot"==r){let e=N("Attribute",t);return e.value=n,m(),e.attr=ge(),E(e)}return n}function Se(){let e=p(),t=me();for(;;){let n=ve(e,t);if(n===t)return t;t=n}}function be(){if(Z[h()]){let e=N("UnaryOp");return e.op=Z[h()],m(),e.operand=be(),E(e)}return function(){p();let e=Se();if("Pow"==h()){let t=N("BinOp");return m(),t.left=e,t.op="Pow",t.right=be(),E(t)}return e}()}const Ne={kind:1,id:2,n:3,s:4,func:5,key:6,elt:7,elts:8,keys:9,left:10,ops:11,comparators:12,names:13,items:14,test:15,targets:16,dims:17,context_expr:18,name:19,bases:20,type:21,inClass:22,target:23,annotation:24,simple:25,op:26,operand:27,right:28,values:29,iter:30,ifs:31,is_async:32,value:33,slice:34,attr:35,generators:36,args:37,keywords:38,body:39,handlers:40,orelse:41,finalbody:42,decorator_list:43,kwonlyargs:44,kw_defaults:45,defaults:46,arg:47},Ee={lineno:1,col_offset:1,startPos:1,endPos:1,kind:1},Ce={body:1,orelse:1,finalbody:1},Ue={_comments:1,ctx:1,ns:1};t.dump=function(t,n=!1){const r=(t,i)=>{if(Array.isArray(i)){let e="";for(let n=0;n<i.length;++n)n>0&&(e+=", "),e+=r(t,i[n]);return"["+e+"]"}if(!i||!i.kind)return JSON.stringify(i);let s="",o=Object.keys(i);o.sort((t,n)=>(Ne[t]||100)-(Ne[n]||100)||e.U.strcmp(t,n));for(let a of o)if(!(e.U.lookup(Ee,a)||n&&e.U.lookup(Ue,a)))if(s&&(s+=", "),s+=a+"=",Array.isArray(i[a])&&i[a].length&&e.U.lookup(Ce,a)){s+="[\n";let e=t+"  ";for(let t of i[a])s+=e+r(e,t)+"\n";s+=t+"]"}else if("_comments"==a){s+="[\n";let e=t+"  ";for(let t of i[a])s+=e+JSON.stringify(t.value)+"\n";s+=t+"]"}else s+=r(t,i[a]);return i.kind+"("+s+")"};let i="";for(let e of t)i+=r("",e)+"\n";return i},t.parse=function(m,y,k){i=m,s=y,r=k,n=0,o=0,a=[],l=[0],c=[];let x=[];try{if(u=r[0],f(),p().type!=t.TokenType.EOF)for(x=B();p().type!=t.TokenType.EOF;)e.U.pushRange(x,B())}catch(t){d(9572,e.U.lf("exception: {0}",t.message))}return{stmts:x,diagnostics:c}}}(e.py||(e.py={}))}(pxt||(pxt={})),function(e){!function(t){function n(e,t,n){const r={fileName:e.getSourceFile().fileName,start:e.getStart(),length:e.getEnd()-e.getStart(),line:void 0,column:void 0,code:t,category:pxtc.DiagnosticCategory.Error,messageText:n},i=new Error(n);throw i.pyDiagnostic=r,i}t.decompileToPython=function(s,o){let a={blocksInfo:void 0,outfiles:{},diagnostics:[],success:!0,times:{}};try{let l=function(s,o){const a=s.getTypeChecker(),l=(new ts.pxtc.LSHost(s),s.getSourceFile(o)),u=pxtc.decompiler.buildCommentMap(l),c=e.U.toSet(k(),e=>e),[p,f]=ts.pxtc.decompiler.buildRenameMap(s,l,{takenNames:c,declarations:"all"}),m=pxtc.getApiInfo(s),d=e.U.mapMap(m.byQName,(e,t)=>t.fileName==o?void 0:t),y=t.computeScopeVariableLookup(l);return E(l);function k(){return["ArithmeticError","AssertionError","AttributeError","BaseException","BlockingIOError","BrokenPipeError","BufferError","BytesWarning","ChildProcessError","ConnectionAbortedError","ConnectionError","ConnectionRefusedError","ConnectionResetError","DeprecationWarning","EOFError","Ellipsis","EnvironmentError","Exception","False","FileExistsError","FileNotFoundError","FloatingPointError","FutureWarning","GeneratorExit","IOError","ImportError","ImportWarning","IndentationError","IndexError","InterruptedError","IsADirectoryError","KeyError","KeyboardInterrupt","LookupError","MemoryError","NameError","None","NotADirectoryError","NotImplemented","NotImplementedError","OSError","OverflowError","PendingDeprecationWarning","PermissionError","ProcessLookupError","RecursionError","ReferenceError","ResourceWarning","RuntimeError","RuntimeWarning","StopAsyncIteration","StopIteration","SyntaxError","SyntaxWarning","SystemError","SystemExit","TabError","TimeoutError","True","TypeError","UnboundLocalError","UnicodeDecodeError","UnicodeEncodeError","UnicodeError","UnicodeTranslateError","UnicodeWarning","UserWarning","ValueError","Warning","ZeroDivisionError","_","__build_class__","__debug__","__doc__","__import__","__loader__","__name__","__package__","__spec__","abs","all","any","ascii","bin","bool","bytearray","bytes","callable","chr","classmethod","compile","complex","copyright","credits","delattr","dict","dir","divmod","enumerate","eval","exec","exit","filter","float","format","frozenset","getattr","globals","hasattr","hash","help","hex","id","input","int","isinstance","issubclass","iter","len","license","list","locals","map","max","memoryview","min","next","object","oct","open","ord","pow","print","property","quit","range","repr","reversed","round","set","setattr","slice","sorted","staticmethod","str","sum","super","tuple","type","vars","zip",...Object.keys(e.py.keywords)]}function x(e){if(!e.getSourceFile())return null;let t=e.getText();return d[t]||null}function T(e){if(!e.getSourceFile())return null;let t=e.getText();const n=a.getSymbolAtLocation(e);n&&(t=a.getFullyQualifiedName(n));let r=d[t];if(r&&r.attributes.alias)return r.attributes.alias;if(r&&r.pyQName){if(r.isInstance){if(ts.isPropertyAccessExpression(e))return null;const t=new RegExp(`(?:^|.)${r.namespace}.(.+)`).exec(r.pyQName);if(t)return t[1]}return r.pyQName}return t in pxtc.ts2PyFunNameMap?pxtc.ts2PyFunNameMap[t].n:null}function g(t){let r=T(t);if(r)return r;if(!ts.isIdentifier(t))return e.tickEvent("depython.todo.advancedname"),n(t,3001,"Unsupported advanced name format: "+t.getText());let i=t.text;if(t.getSourceFile()){const e=p.getRenameForPosition(t.getStart());e&&(i=e.name)}return i}function h(e){return"string"!=typeof e&&(e=g(e)),f[e]?pxtc.decompiler.getNewName(e,f):(f[e]=!0,e)}function v(e,t){return 0!==(e.flags&t)}function S(e,t){return v(a.getTypeAtLocation(e),t)}function b(e){return S(e,ts.TypeFlags.StringLike)}function N(e){return S(e,ts.TypeFlags.NumberLike)}function E(e){let t=e.getChildren().map(C).reduce((e,t)=>e.concat(t),[]).reduce((e,t)=>t||e[e.length-1]?[...e,t]:e,[]);return u.filter(e=>!e.owner).forEach(e=>t.push(...U(e))),t.join("\n")}function C(e){switch(e.kind){case ts.SyntaxKind.SyntaxList:return e._children.map(C).reduce((e,t)=>e.concat(t),[]);case ts.SyntaxKind.EndOfFileToken:case ts.SyntaxKind.OpenBraceToken:case ts.SyntaxKind.CloseBraceToken:return[];default:return P(e)}}function U(e){let t=[];if(e.kind===pxtc.decompiler.CommentKind.SingleLine)t.push("# "+e.text);else{t.push('"""');for(const n of e.lines)t.push(n);t.push('"""')}return t}function P(e){const t=I(e);return pxtc.decompiler.getCommentsForStatement(e,u).map(U).reduce((e,t)=>e.concat(t),[]).concat(t)}function I(t){return ts.isVariableStatement(t)?M(t):ts.isClassDeclaration(t)?G(t):ts.isEnumDeclaration(t)?B(t):ts.isExpressionStatement(t)?X(t):ts.isFunctionDeclaration(t)?Z(t):ts.isIfStatement(t)?R(t):ts.isForStatement(t)?O(t):ts.isForOfStatement(t)?D(t):ts.isWhileStatement(t)?K(t):ts.isReturnStatement(t)?_(t):ts.isBlock(t)?Y(t):ts.isTypeAliasDeclaration(t)?A(t):ts.isEmptyStatement(t)?[]:ts.isModuleDeclaration(t)?w(t):ts.isBreakStatement(t)?["break"]:ts.isContinueStatement(t)?["continue"]:(e.tickEvent("depython.todo.statement",{statement:t.kind}),n(t,3002,`Not supported in MakeCode Python: ${ts.SyntaxKind[t.kind]} (${t.kind})`))}function w(e){let n=g(e.name),r=e.body&&e.body.getChildren().map(C).reduce((e,t)=>e.concat(t),[]).map(e=>t.indent1(e));return["@namespace",`class ${n}:`].concat(r||[])}function A(e){let t=pxtc.emitPyTypeFromTypeNode(e.type);return[`${g(e.name)} = ${t}`]}function _(e){if(!e.expression)return["return"];let[t,n]=Pe(e.expression),r=ie("return ",t);return n.concat(r)}function K(e){let[t,n]=Pe(e.expression),r=F(e.statement),i=ie("while ",t,":");return n.concat(i).concat(r)}function $(e){let t=Math.floor(Number(e));return t!==1/0&&String(t)===e}function L(e){if(!e.initializer)return null;if(e.initializer.kind!==ts.SyntaxKind.VariableDeclarationList)return null;let t=e.initializer;if(1!==t.declarations.length)return null;let n=t.declarations[0],r=g(n.name);if(!n.initializer||!Ce(n.initializer)||!N(n.initializer))return null;let[i,s]=Pe(n.initializer);if(s.length)return null;let o=re(i);if(!e.condition)return null;if(!ts.isBinaryExpression(e.condition))return null;if(!ts.isIdentifier(e.condition.left))return null;if(g(e.condition.left)!=r)return null;if(!N(e.condition.right))return null;let[a,l]=Pe(e.condition.right);if(l.length)return null;let u=re(a),c=u;if(e.condition.operatorToken.kind===ts.SyntaxKind.LessThanEqualsToken&&$(u))c=""+(Number(u)+1);else if(e.condition.operatorToken.kind!==ts.SyntaxKind.LessThanToken)return null;return e.incrementor&&(ts.isPostfixUnaryExpression(e.incrementor)||ts.isPrefixUnaryExpression(e.incrementor))?e.incrementor.operator!==ts.SyntaxKind.PlusPlusToken?null:o<c?{name:r,fromIncl:o,toExcl:c}:null:null}function F(e){let n=I(e).map(t.indent1);return n.length<1&&(n=[t.indent1("pass")]),n}function D(t){if(!ts.isVariableDeclarationList(t.initializer))return e.tickEvent("depython.todo.forof.complexexp"),n(t,3003,"Unsupported expression in for..of initializer: "+t.initializer.getText());let r=t.initializer.declarations.map(e=>g(e.name));if(1!==r.length)return e.tickEvent("depython.todo.forof.multidecl"),n(t,3004,"Unsupported multiple declerations in for..of: "+t.initializer.getText());let i=r[0],[s,o]=Pe(t.expression),a=o;a=a.concat(ie(`for ${i} in `,s,":"));let l=F(t.statement);return a=a.concat(l),a}function O(e){let n=L(e);if(n){let{name:t,fromIncl:r,toExcl:i}=n,s="0"===r?`for ${t} in range(${i}):`:`for ${t} in range(${r}, ${i}):`,o=F(e.statement);return[s].concat(o)}let r,i=[];if(e.initializer)if(ts.isVariableDeclarationList(e.initializer)){let t=e.initializer.declarations.map(te).reduce((e,t)=>e.concat(t),[]);i=i.concat(t)}else{let[t,n]=Pe(e.initializer);i=i.concat(n).concat(t)}if(e.condition){let[t,n]=Pe(e.condition);i=i.concat(n),r=re(t)}else r="True";let s=`while ${r}:`;i.push(s);let o=I(e.statement).map(t.indent1);if(0!==o.length||e.incrementor||(o=[t.indent1("pass")]),i=i.concat(o),e.incrementor){let n=J(e.incrementor);if(n)i=i.concat(n.map(t.indent1));else{let[n,r]=Pe(e.incrementor);i=i.concat(r).concat(n.map(t.indent1))}}return i}function R(e){let{supportStmts:t,ifStmt:n,rest:r}=q(e);return t.concat([n]).concat(r)}function q(e){let t=[],[n,r]=Pe(e.expression);t=t.concat(r);let i=`if ${re(n)}:`,s=[],o=F(e.thenStatement);if(s=s.concat(o),e.elseStatement)if(ts.isIfStatement(e.elseStatement)){let{supportStmts:n,ifStmt:r,rest:i}=q(e.elseStatement),o=`el${r}`;t=t.concat(n),s.push(o),s=s.concat(i)}else{s.push("else:");let t=F(e.elseStatement);s=s.concat(t)}return{supportStmts:t,ifStmt:i,rest:s}}function M(e){return e.declarationList.declarations.map(te).reduce((e,t)=>e.concat(t),[])}function G(r){if(!i)return e.tickEvent("depython.todo.classes"),n(r,3016,"Unsupported: classes are not supported in Python right now.");let s=[];if(!r.name)return e.tickEvent("depython.todo.anonymousclass"),n(r,3011,"Unsupported: anonymous class");let o=r.members.every(Q),a=g(r.name);o?s.push(`class ${a}(Enum):`):s.push(`class ${a}:`);let l=r.members.map(z).reduce((e,t)=>e.concat(t),[]).filter(e=>e);return l.length&&(s=s.concat(l.map(t.indent1))),s}function B(r){let i=[];i.push(`class ${g(r.name)}(Enum):`);let s=r.members.every(e=>!!e.initializer),o=!r.members.every(e=>!!e.initializer);if(!s&&!o)return e.tickEvent("depython.todo.enummix"),n(r,3005,"Unsupported enum decleration: has mixture of explicit and implicit initialization");if(s)return e.tickEvent("depython.todo.enuminit"),n(r,3006,"Unsupported: explicit enum initialization");let a=0;for(let e of r.members)i.push(t.indent1(`${g(e.name)} = ${a++}`));return i}function Q(e){if(e.kind!==ts.SyntaxKind.PropertyDeclaration)return!1;let t=e;if(!t.modifiers||1!==t.modifiers.length)return!1;for(let e of t.modifiers)if(e.kind!==ts.SyntaxKind.StaticKeyword)return!1;return!!t.initializer&&t.initializer.kind===ts.SyntaxKind.NumericLiteral}function z(e){return ts.isPropertyDeclaration(e)?V(e):ts.isMethodDeclaration(e)?Z(e):ts.isConstructorDeclaration(e)?W(e):["# unknown ClassElement "+e.kind]}function W(e){let n=[];const r=e.parameters.filter(ts.isParameterPropertyDeclaration);return r.forEach(e=>{n=[...n,...V(e)]}),n=[...n,...Z(e,"__init__")],r.length&&n.slice(-1)[0].endsWith("pass")&&n.pop(),r.forEach(e=>{const r=g(e.name);n.push(t.indent1(`self.${r} = ${r}`))}),n}function j(e){return v(e,ts.TypeFlags.NumberLike)?"0":v(e,ts.TypeFlags.StringLike)?'""':v(e,ts.TypeFlags.BooleanLike)?"False":void 0}function V(t){let r=g(t.name);if(t.initializer){let[e,n]=Pe(t.initializer);return[...n,`${r} = ${re(e)}`]}if(ts.isParameterPropertyDeclaration(t)&&t.type){const e=j(a.getTypeFromTypeNode(t.type));if(e)return[`${r} = ${e}`]}return e.tickEvent("depython.todo.classwithoutinit"),n(t,3006,"Unsupported: class properties without initializers")}function H(e){return!(!ts.isPrefixUnaryExpression(e)&&!ts.isPostfixUnaryExpression(e))&&(e.operator===ts.SyntaxKind.MinusMinusToken||e.operator===ts.SyntaxKind.PlusPlusToken)}function J(e){if(!H(e))return null;let[t,n]=Pe(e.operand),r=e.operator===ts.SyntaxKind.MinusMinusToken?" -= 1":" += 1",i=n;return i.push(`${re(t)}${r}`),i}function X(e){let t=J(e.expression);if(t)return t;const[n,r]=Pe(e.expression);return r.length?["",...r,...n,""]:[...r,...n]}function Y(e){return e.getChildren().map(C).reduce((e,t)=>e.concat(t),[])}function Z(r,i,s,o){let a=[];r.kind!==ts.SyntaxKind.MethodDeclaration&&r.kind!==ts.SyntaxKind.Constructor||a.push("self");let l=(s?me(r.parameters,s):r.parameters).map(e=>ee(e,!o));a=a.concat(l);let u,c=a.join(", "),p=[];if(i)u=i;else{if(!r.name)return e.tickEvent("depython.todo.anonymousfunc"),n(r,3012,"Unsupported: anonymous function decleration");u=g(r.name)}if(p.push(`def ${u}(${c}):`),!r.body)return e.tickEvent("depython.todo.funcwithoutbody"),n(r,3013,"Unsupported: function decleration without body");let f=[];if(ts.isBlock(r.body))f=Y(r.body);else{let[e,t]=Pe(r.body);f=f.concat(t),f.concat(e)}if(f.length){let e=y.getExplicitGlobals(r).map(e=>g(e));e&&e.length&&f.unshift(`global ${e.join(", ")}`);let n=y.getExplicitNonlocals(r).map(e=>g(e));n&&n.length&&f.unshift(`nonlocal ${n.join(", ")}`),p=p.concat(f.map(t.indent1))}else p.push(t.indent1("pass"));return p}function ee(t,r=!0){let i=t.altName||g(t.name),s="";if(t.type&&r){let e=pxtc.emitPyTypeFromTypeNode(t.type);e&&-1===e.indexOf("(TODO")&&(s=`: ${e}`)}let o="";if(t.initializer){let[r,i]=Pe(t.initializer);if(i.length)return e.tickEvent("depython.todo.complexinit"),n(t,3007,`Unsupported: complex expression in parameter default value not supported. Expression: ${t.initializer.getText()}`);o=` = ${re(r)}`}return`${i}${s}${o}`}function te(e){let t=[],n=g(e.name);if(e.initializer){let r,[i,s]=Pe(e.initializer);if(t=t.concat(s),e.type){r=`${n}: ${pxtc.emitPyTypeFromTypeNode(e.type)} = ${re(i)}`}else r=`${n} = ${re(i)}`;return t.push(r),t}return t}function ne(e,t){return[[e],t||[]]}function re(e,t="\n"){return e.join(t)}function ie(e="",t,n=""){return t[0]=e+t[0],t[t.length-1]=t[t.length-1]+n,t}function se(t,r){switch(t){case ts.SyntaxKind.BarBarToken:return"or";case ts.SyntaxKind.AmpersandAmpersandToken:return"and";case ts.SyntaxKind.ExclamationToken:return"not";case ts.SyntaxKind.LessThanToken:return"<";case ts.SyntaxKind.LessThanEqualsToken:return"<=";case ts.SyntaxKind.GreaterThanToken:return">";case ts.SyntaxKind.GreaterThanEqualsToken:return">=";case ts.SyntaxKind.EqualsEqualsEqualsToken:case ts.SyntaxKind.EqualsEqualsToken:return"==";case ts.SyntaxKind.ExclamationEqualsEqualsToken:case ts.SyntaxKind.ExclamationEqualsToken:return"!=";case ts.SyntaxKind.EqualsToken:return"=";case ts.SyntaxKind.PlusToken:return"+";case ts.SyntaxKind.MinusToken:return"-";case ts.SyntaxKind.AsteriskToken:return"*";case ts.SyntaxKind.PlusEqualsToken:return"+=";case ts.SyntaxKind.MinusEqualsToken:return"-=";case ts.SyntaxKind.PercentToken:return"%";case ts.SyntaxKind.SlashToken:return"/";case ts.SyntaxKind.PlusPlusToken:case ts.SyntaxKind.MinusMinusToken:return e.tickEvent("depython.todo.unsupportedop",{op:t}),n(r,3008,"Unsupported ++ and -- in an expression (not a statement or for loop)");case ts.SyntaxKind.AmpersandToken:return"&";case ts.SyntaxKind.CaretToken:return"^";case ts.SyntaxKind.LessThanLessThanToken:return"<<";case ts.SyntaxKind.GreaterThanGreaterThanToken:return">>";case ts.SyntaxKind.GreaterThanGreaterThanGreaterThanToken:return e.tickEvent("depython.todo.unsupportedop",{op:t}),n(r,3009,"Unsupported operator: >>>");case ts.SyntaxKind.AsteriskAsteriskToken:return"**";case ts.SyntaxKind.AsteriskAsteriskEqualsToken:return"**=";case ts.SyntaxKind.PercentEqualsToken:return"%=";case ts.SyntaxKind.AsteriskEqualsToken:return"*=";case ts.SyntaxKind.SlashEqualsToken:return"/=";default:return e.tickEvent("depython.todo.unsupportedop",{op:t}),n(r,3008,`Unsupported Python operator (code: ${t})`)}}function oe(e){let t=b(e.left),n=b(e.right),r=e.operatorToken.kind===ts.SyntaxKind.PlusToken&&(t||n),[i,s]=Pe(e.left);r&&!t&&(i=ie("str(",i,")"));let o=se(e.operatorToken.kind,e),[a,l]=Pe(e.right);r&&!n&&(a=ie("str(",a,")"));let u=s.concat(l);return[ie(re(i)+" "+o+" ",a),u]}function ae(e){let t=T(e);if(t)return ne(t);let[n,r]=Pe(e.expression),i=g(e.name);return ne("length"===i?`len(${re(n)})`:`${re(n)}.${i}`,r)}function le(e){if(ts.isPropertyAccessExpression(e)){let t=g(e.name),n=t.substr(t.lastIndexOf(".")+1);return ts.isIdentifier(e.expression)?[n]:le(e.expression).concat([n])}return ts.isIdentifier(e)?[g(e)]:[]}function ue(t,n,r,i){let s="";n&&(s=le(n).map(e.U.snakify).join("_"));let o=[];if(r&&r.length>1&&i&&i.length>1)for(let t=0;t<r.length&&t<i.length;t++){let n=i[t];if(v(a.getTypeAtLocation(n),ts.TypeFlags.EnumLike)){let t=le(n).map(e.U.snakify);o=o.concat(t)}}let l=o.join("_"),u="";s||l||!t||(u=g(t.name));let c=([s,l,u].filter(e=>e).map(e.U.snakify).map(e=>e.toLowerCase()).join("_")||"my_callback").split("_");c.length>4&&(c=f(c));let p=e.U.toDictionary(["any","on","event"],e=>e);for(;c.length>2;){let e=m(c,p);if(e.length==c.length)break;c=e}return c=["on",...c],c.join("_");function f(e){let t={},n=[];for(let r of e)r in t||(t[r]=!0,n.push(r));return n}function m(e,t){let n=[],r=!1;for(let i of e)!(i in t)||r?n.push(i):r=!0;return n}}function ce(e){let n=e.join(", ");return n.length>60&&e.length>1?e.map((n,r)=>{let i=","==n.charAt(n.length-1)?"":",";if(0==r){let e=n.split("\n");if(e.length>1){n=e.shift()+"\n"+t.indent1(e.join("\n"))}return n+i}return r==e.length-1?t.indent1(n):t.indent1(n+i)}):[n]}function pe(e,t,n,r,i){if((ts.isFunctionExpression(e)||ts.isArrowFunction(e))&&t&&t.type&&ts.isFunctionTypeNode(t.type)){let s;return de(e,ue(t,n,r,i),s,!0)}return Pe(e)}function fe(t){let r=a.getTypeAtLocation(t.expression),i=a.typeToTypeNode(r),s=ts.createNodeArray([]);if(ts.isFunctionTypeNode(i)&&(s=i.parameters,t.arguments&&s.length<t.arguments.length))return e.tickEvent("depython.todo.argparammismatch",{kind:t.kind}),n(t,3010,"TODO: Unsupported call site where caller the arguments outnumber the callee parameters: "+t.getText());const o=x(t.expression);if(t.arguments&&o&&"TD_ID"==o.attributes.shim)return Pe(t.arguments[0]);if(ts.isPropertyAccessExpression(t.expression)&&"toString"===t.expression.name.getText()){const[e,n]=Pe(t.expression.expression);return[ie("str(",e,")"),n]}let[l,u]=Pe(t.expression),c=re(l),p=(t.arguments||ts.createNodeArray()).map((e,n,r)=>pe(e,s[n],t.expression,s,r)),f=p.map(([e,t])=>t).reduce((e,t)=>e.concat(t),u);if(0===c.indexOf("_py.py_")){if(p.length<=0)return e.tickEvent("depython.todo._pynoargs"),n(t,3014,"Unsupported: call expression has no arguments for _py.py_ fn");c=c.substr(7).split("_").filter((e,t)=>0!==t).join("_");return[ie(`${p.shift()[0]}.${c}(`,ce(p.map(([e,t])=>e).reduce((e,t)=>e.concat(t),[])),")"),f]}return[ie(`${c}(`,ce(p.map(([e,t])=>e).reduce((e,t)=>e.concat(t),[])),")"),f]}function me(e,t){let n=[],r={};for(let i=0;i<Math.max(e.length,t.length);i++){let s;if(e[i])s=e[i],r[g(s.name)]=!0;else{s=t[i];let e=g(s.name);r[e]&&(e=pxtc.decompiler.getNewName(e,r),s=Object.assign({altName:e},t[i]))}n.push(s)}return ts.createNodeArray(n,!1)}function de(e,t,n,i){if(r&&!ts.isBlock(e.body)){let[t,r]=Pe(e.body);if(0===r.length){let r=(n?me(e.parameters,n):e.parameters).map(e=>ee(e,!1)).join(", ");return ne(r.length?`lambda ${r}: ${re(t)}`:`lambda: ${re(t)}`)}}let s=e.name?g(e.name):h(t||"my_function");return ne(s,Z(e,s,n,i))}function ye(e){switch(e){case ts.SyntaxKind.ExclamationToken:return" ";case ts.SyntaxKind.PlusToken:case ts.SyntaxKind.MinusToken:return"";default:return" "}}function ke(e){let t=se(e.operator,e),[n,r]=Pe(e.operand);return ne(`${t}${ye(e.operator)}${re(n)}`,r)}function xe(e){let t=se(e.operator,e),[n,r]=Pe(e.operand),i=ye(e.operator);return ne(`${re(n)}${i}${t}`,r)}function Te(e){let t=e.elements.map(Pe),n=t.map(([e,t])=>t).reduce((e,t)=>e.concat(t),[]);return[ie("[",ce(t.map(([e,t])=>e).reduce((e,t)=>e.concat(t),[])),"]"),n]}function ge(t){if(!t.argumentExpression)return e.tickEvent("depython.todo.accesswithoutexp"),n(t,3015,"Unsupported: element access expression without an argument expression");let[r,i]=Pe(t.expression),[s,o]=Pe(t.argumentExpression),a=i.concat(o);return ne(`${re(r)}[${re(s)}]`,a)}function he(e){let[t,n]=Pe(e.expression);return ne(`(${re(t)})`,n)}function ve(e){if(ts.isNoSubstitutionTemplateLiteral(e))return ne(`"""\n${e.text.trim().split("\n").map(e=>`${t.INDENT}${e.trim()}`).join("\n")}\n${t.INDENT}"""`);let[n,r]=Pe(e.tag),[i,s]=Pe(e.template),o=r.concat(s);return ne(`${re(n)}(${re(i)})`,o)}function Se(e){if("undefined"==e.text)return ne("None");return ne(g(e))}function be(e,t){let n=e=>be(e,t);return ts.isBinaryExpression(e)?n(e.left)&&n(e.right):ts.isPropertyAccessExpression(e)?n(e.expression):ts.isPrefixUnaryExpression(e)||ts.isPostfixUnaryExpression(e)?e.operator!==ts.SyntaxKind.PlusPlusToken&&e.operator!==ts.SyntaxKind.MinusMinusToken&&n(e.operand):ts.isParenthesizedExpression(e)?n(e.expression):ts.isArrayLiteralExpression(e)?e.elements.map(n).reduce((e,t)=>e&&t,!0):ts.isElementAccessExpression(e)?n(e.expression)&&(!e.argumentExpression||n(e.argumentExpression)):t(e)}function Ne(e){return e.parent?e.parent.kind===ts.SyntaxKind.ParenthesizedExpression?Ne(e.parent):e.parent:void 0}function Ee(e){if("any"===e.type.getText().trim()&&(ts.isNumericLiteral(e.expression)||ts.isStringLiteral(e.expression)||e.expression.kind===ts.SyntaxKind.TrueKeyword||e.expression.kind===ts.SyntaxKind.FalseKeyword)){const t=Ne(e);if((null==t?void 0:t.kind)===ts.SyntaxKind.BinaryExpression)switch(t.operatorToken.kind){case ts.SyntaxKind.EqualsEqualsToken:case ts.SyntaxKind.EqualsEqualsEqualsToken:case ts.SyntaxKind.ExclamationEqualsToken:case ts.SyntaxKind.ExclamationEqualsEqualsToken:case ts.SyntaxKind.LessThanToken:case ts.SyntaxKind.LessThanEqualsToken:case ts.SyntaxKind.GreaterThanToken:case ts.SyntaxKind.GreaterThanEqualsToken:return!0}}return!1}function Ce(e){let t=e=>{switch(e.kind){case ts.SyntaxKind.PropertyAccessExpression:case ts.SyntaxKind.BinaryExpression:case ts.SyntaxKind.ParenthesizedExpression:case ts.SyntaxKind.ArrayLiteralExpression:case ts.SyntaxKind.ElementAccessExpression:case ts.SyntaxKind.TrueKeyword:case ts.SyntaxKind.FalseKeyword:case ts.SyntaxKind.NullKeyword:case ts.SyntaxKind.UndefinedKeyword:case ts.SyntaxKind.NumericLiteral:case ts.SyntaxKind.StringLiteral:case ts.SyntaxKind.NoSubstitutionTemplateLiteral:return!0;case ts.SyntaxKind.CallExpression:case ts.SyntaxKind.NewExpression:case ts.SyntaxKind.FunctionExpression:case ts.SyntaxKind.ArrowFunction:case ts.SyntaxKind.Identifier:case ts.SyntaxKind.ThisKeyword:return!1;case ts.SyntaxKind.PrefixUnaryExpression:case ts.SyntaxKind.PostfixUnaryExpression:let t=e;return t.operator!==ts.SyntaxKind.PlusPlusToken&&t.operator!==ts.SyntaxKind.MinusMinusToken}return!1};return be(e,t)}function Ue(e){let[t,n]=Pe(e.condition),[r,i]=Pe(e.whenTrue),[s,o]=Pe(e.whenFalse),a=n.concat(i).concat(o);return ne(`${r} if ${re(t)} else ${re(s)}`,a)}function Pe(t){if(ts.isBinaryExpression(t))return oe(t);if(ts.isPropertyAccessExpression(t))return ae(t);if(ts.isCallExpression(t))return fe(t);if(ts.isNewExpression(t))return fe(t);if(ts.isFunctionExpression(t)||ts.isArrowFunction(t))return de(t);if(ts.isPrefixUnaryExpression(t))return ke(t);if(ts.isPostfixUnaryExpression(t))return xe(t);if(ts.isParenthesizedExpression(t))return he(t);if(ts.isArrayLiteralExpression(t))return Te(t);if(ts.isElementAccessExpression(t))return ge(t);if(ts.isNoSubstitutionTemplateLiteral(t)||ts.isTaggedTemplateExpression(t))return ve(t);switch(t.kind){case ts.SyntaxKind.TrueKeyword:return ne("True");case ts.SyntaxKind.FalseKeyword:return ne("False");case ts.SyntaxKind.ThisKeyword:return ne("self");case ts.SyntaxKind.NullKeyword:case ts.SyntaxKind.UndefinedKeyword:return ne("None")}return ts.isIdentifier(t)?Se(t):ts.isNumericLiteral(t)||ts.isStringLiteral(t)?ne(t.getText()):ts.isConditionalExpression(t)?Ue(t):ts.isAsExpression(t)&&Ee(t)?Pe(t.expression):(e.tickEvent("depython.todo.expression",{kind:t.kind}),n(t,3017,"Unsupported expression kind: "+t.kind))}}(s,o),u=o.replace(/(\.py)?\.\w*$/i,"")+".py";a.outfiles[u]=l}catch(t){t.pyDiagnostic?a.diagnostics=[t.pyDiagnostic]:e.reportException(t),a.success=!1}return a};const r=!1,i=!1;function s(e){return n=>(n||"").split("\n").map(n=>`${t.INDENT.repeat(e)}${n}`).join("\n")}t.INDENT="    ",t.indent=s,t.indent1=s(1)}(e.py||(e.py={}))}(pxt||(pxt={})),function(e){!function(e){!function(e){const t=/[\u1680\u2000-\u200a\u202f\u205f\u3000\ufeff]/;e.isIdentifierStart=function(e){return ts.pxtc.isIdentifierStart(e,ts.pxtc.ScriptTarget.ES5)},e.isIdentifierChar=function(e){return ts.pxtc.isIdentifierPart(e,ts.pxtc.ScriptTarget.ES5)},e.isSpace=function(e){return!!(32===e||9===e||11===e||12===e||160===e||e>=5760&&t.test(String.fromCharCode(e)))},e.isNewline=function(e){return 10===e||13===e||(8232===e||8233===e)}}(e.rx||(e.rx={}))}(e.py||(e.py={}))}(pxt||(pxt={})),function(e){!function(e){function t(e){const t={refs:[],children:[],owner:void 0};return function e(r){var i;if(!r)return t;if(ts.isPropertyAccessOrQualifiedName(r))return t;if(ts.isIdentifier(r))return{refs:[{kind:"read",node:r,varName:r.text}],children:[],owner:void 0};if(ts.isVariableDeclaration(r)||ts.isParameter(r)){const t=e(r.initializer);return{refs:[...t.refs,{kind:"decl",node:r,varName:r.name.getText()}],children:t.children,owner:void 0}}if(ts.isPrefixUnaryExpression(r)||ts.isPostfixUnaryExpression(r)){const t=e(r.operand),i=r.operand.getText();return n(t,{refs:[{kind:"assign",node:r,varName:i}],children:[],owner:void 0})}if(function(e){const t=[ts.SyntaxKind.EqualsToken,ts.SyntaxKind.PlusEqualsToken,ts.SyntaxKind.MinusEqualsToken,ts.SyntaxKind.AsteriskEqualsToken,ts.SyntaxKind.AsteriskAsteriskEqualsToken,ts.SyntaxKind.SlashEqualsToken,ts.SyntaxKind.PercentEqualsToken,ts.SyntaxKind.LessThanLessThanEqualsToken,ts.SyntaxKind.GreaterThanGreaterThanEqualsToken,ts.SyntaxKind.GreaterThanGreaterThanGreaterThanEqualsToken,ts.SyntaxKind.AmpersandEqualsToken,ts.SyntaxKind.BarEqualsToken,ts.SyntaxKind.CaretEqualsToken];return ts.isBinaryExpression(e)&&t.some(t=>e.operatorToken.kind===t)}(r)){const t=e(r.right);let i;r.operatorToken.kind!==ts.SyntaxKind.EqualsToken&&(i=e(r.left));const s=r.left.getText();return n(i,n(t,{refs:[{kind:"assign",node:r,varName:s}],children:[],owner:void 0}))}if(ts.isFunctionExpression(r)||ts.isArrowFunction(r)||ts.isFunctionDeclaration(r)||ts.isMethodDeclaration(r)){const s=null===(i=r.name)||void 0===i?void 0:i.getText();let o;s&&(o={kind:"decl",node:r,varName:s});const a=n(r.parameters.map(t=>e(t)).reduce(n,t),e(r.body));return a.owner=r,{refs:o?[o]:[],children:[a],owner:void 0}}return r.getChildren().map(e).reduce(n,t)}(e);function n(e,n){return e&&n?{refs:[...e.refs,...n.refs],children:[...e.children,...n.children],owner:e.owner||n.owner}:e||n||t}}function n(e,t,r=[]){const i=[],s=[],o=[],a=[],l={};for(const n of e.refs)"read"===n.kind||"assign"===n.kind?l[n.varName]?o.push(n):p(n)?s.push(n):t&&t[n.varName]?i.push(n):a.push(n):l[n.varName]=n;const u=t||l,c=t?[...r,l]:[];return{globalUsage:i,nonlocalUsage:s,localUsage:o,environmentUsage:a,children:e.children.map(e=>n(e,u,c)),owner:e.owner};function p(e){return r.map(t=>t[e.varName]).reduce((e,t)=>t||e,void 0)}}function r(e){return`${e.kind}:${e.varName}`}e.computeScopeVariableLookup=function(e){const r=n(t(e)),i=new Map,s=new Map;return function e(t){const n=a((r=t,[...r.globalUsage,...r.environmentUsage].filter(e=>"assign"===e.kind).map(e=>e)));var r;i.set(t.owner,n);const o=a(function(e){return e.nonlocalUsage.filter(e=>"assign"===e.kind).map(e=>e)}(t));s.set(t.owner,o),t.children.forEach(e)}(r),{getExplicitGlobals:e=>i.get(e)||[],getExplicitNonlocals:e=>s.get(e)||[]};function o(e){let t=e.node.operand||e.node.left;return ts.isIdentifier(t)?t:void 0}function a(e){return e.map(o).filter(e=>!!e).map(e=>e).reduce((e,t)=>e.find(e=>e.text===t.text)?e:[...e,t],[])}},e.toStringVariableScopes=function(i){const s=t(i),o=n(s);return function t(n){return[n.refs.map(r).join(", "),...n.children.map(t).map(t=>t.map(e.indent1)).map(e=>["{",...e,"}"]).reduce((e,t)=>[...e,...t],[])]}(s).join("\n")+"\n\n\n"+function(t){return function t(n){const i=n.globalUsage.map(r).join(", "),s=n.nonlocalUsage.map(r).join(", "),o=n.localUsage.map(r).join(", "),a=n.environmentUsage.map(r).join(", ");return[i?"global "+i:"",s?"nonlocal "+s:"",o?"local "+o:"",a?"env "+a:"",...n.children.map(t).map(t=>t.map(e.indent1)).map(e=>["{",...e,"}"]).reduce((e,t)=>[...e,...t],[])].filter(e=>!!e)}(t).join("\n")}(o)}}(e.py||(e.py={}))}(pxt||(pxt={}));